\part{Problems and Applications}% ===> this file was generated automatically by noweave --- better not edit it
\label{part-problems}

\chapter{Traveling Salesman Problems}
\label{intro-tsp}

\nwfilename{src/intro-tsp.nw}\nwfilename{src/intro-pdp.nw}\nwbegindocs{0}\chapter{Pickup and Delivery Problems}
\label{intro-pdp}

\nwenddocs{}\nwfilename{src/intro-rsp.nw}\nwbegindocs{0}\chapter{Ridesharing Problems}
\label{intro-rsp}

\nwenddocs{}\nwfilename{src/search-overview.nw}\nwbegindocs{0}\part{Search-Based Clients}
\label{part-search}

\chapter{Overview}
\label{search-overview}

\renewcommand{\thepage}{\arabic{page}}
\setcounter{page}{1}

\begin{figure}[h]
\centering
\includegraphics{fig/search-overview-workflow.tikz}
\caption{Workflow of Search-Based Clients}
\label{search-overview: fig-workflow}
\end{figure}

\nwenddocs{}\nwfilename{src/search-filters.nw}\nwbegindocs{0}\chapter{Maps and Filters}
\label{search-filters}

Each server can be mapped to a quantitative value indicating its ``fitness''
for a given request.  If the fitness is low, the server can be removed
immediately from further consideration. This chapter implements some example
map and filter functions for determining fitness and whether or not to keep a
server.

\section{Schedule Length}

A server with a very long schedule can be difficult to evaluate because there
will be more scheduling possibilities. Filtering these servers out may improve
the speed performance.

\nwenddocs{}\nwbegincode{1}\sublabel{NWEBrBs-3tu5Lh-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWEBrBs-3tu5Lh-1}}}\moddef{Map/Filter: Schedule Length~{\nwtagstyle{}\subpageref{NWEBrBs-3tu5Lh-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW2W5UTV-4ZdLuY-1}}\nwenddeflinemarkup
for (final int sid : candidates.keySet()) \{
  final int val = this.communicator.queryServerScheduleRemaining(sid,
      this.communicator.retrieveClock()).length / 4;
  if (val <= MAX_SCHEDULE_LENGTH)
    results.put(sid, val);
\}
\nwused{\\{NW2W5UTV-4ZdLuY-1}}\nwendcode{}\nwbegindocs{2}\nwdocspar

\section{Proximity}

Proximity is easy to compute and can be used to approximate actual pick-up
distance. In the filter, we disregard zero proximities due to Limitation \#4.

\nwenddocs{}\nwbegincode{3}\sublabel{NWEBrBs-4AhmPL-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWEBrBs-4AhmPL-1}}}\moddef{Map/Filter: Proximity~{\nwtagstyle{}\subpageref{NWEBrBs-4AhmPL-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwenddeflinemarkup
for (final int sid : candidates.keySet()) \{
  final int val = this.tools.computeHaversine(luv.get(sid), ro);
  if (0 < val && val <= MAX_PROXIMITY)
    results.put(sid, val);
\}
\nwused{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwendcode{}\nwbegindocs{4}\nwdocspar

\section{Perpendicular}

\nwenddocs{}\nwbegincode{5}\sublabel{NWEBrBs-4C3qWe-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWEBrBs-4C3qWe-1}}}\moddef{Map/Filter: Perpendicular~{\nwtagstyle{}\subpageref{NWEBrBs-4C3qWe-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW2W5UTV-wXujK-1}}\nwenddeflinemarkup
int __now = this.communicator.retrieveClock();
for (final int sid : candidates.keySet()) \{
  int[] route = \{ \};
  \LA{}Utilities: get route cache~{\nwtagstyle{}\subpageref{NW2LUTbN-1fC59W-1}}\RA{}
  int min_to_o = Integer.MAX_VALUE;
  int min_to_d = Integer.MAX_VALUE;
  for (int __i = 0; __i < route.length - 1; __i += 2*ROUTE_SKIP_EVERY_N) \{
    if (route[__i] > __now) \{
      int val_to_o = this.tools.computeHaversine(route[(__i + 1)], ro);
      int val_to_d = this.tools.computeHaversine(route[(__i + 1)], rd);
      if (val_to_o < min_to_o) \{
          min_to_o = val_to_o;
      \}
      if (val_to_d < min_to_d) \{
          min_to_d = val_to_d;
      \}
    \}
  \}
  if (min_to_o == Integer.MAX_VALUE || min_to_d == Integer.MAX_VALUE) \{
    min_to_o = candidates.get(sid);  // carry over the existing value
    min_to_d = 0;
  \}
  results.put(sid, (min_to_o + min_to_d));
\}
\nwused{\\{NW2W5UTV-wXujK-1}}\nwendcode{}\nwbegindocs{6}\nwdocspar


\nwenddocs{}\nwfilename{src/search-reductions.nw}\nwbegindocs{0}\chapter{Candidate Reductions}
\label{search-reductions}

\section{Random Reduction}

\nwenddocs{}\nwbegincode{1}\sublabel{NW2D7mP3-4CvaEx-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW2D7mP3-4CvaEx-1}}}\moddef{Reduce: Random~{\nwtagstyle{}\subpageref{NW2D7mP3-4CvaEx-1}}}\endmoddef\nwstartdeflinemarkup\nwenddeflinemarkup
\{
  Random random = new Random();
  List<Integer> keys = new ArrayList<Integer>(candidates.keySet());
  int randomKey = keys.get(random.nextInt(keys.size()));
  cand = Map.entry(randomKey, candidates.get(randomKey));
\}
\nwnotused{Reduce: Random}\nwendcode{}\nwbegindocs{2}\nwdocspar

\section{Minimum Reduction}

\nwenddocs{}\nwbegincode{3}\sublabel{NW2D7mP3-YFiQd-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW2D7mP3-YFiQd-1}}}\moddef{Reduce: Minimum Value~{\nwtagstyle{}\subpageref{NW2D7mP3-YFiQd-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwenddeflinemarkup
for (final Entry<Integer, Integer> entry : candidates.entrySet()) \{
  if (cand == null || cand.getValue() > entry.getValue()) \{
    cand = entry;
  \}
\}
\nwused{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwendcode{}\nwbegindocs{4}\nwdocspar

\section{Maximum Reduction}

\nwenddocs{}\nwbegincode{5}\sublabel{NW2D7mP3-2K8kfr-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW2D7mP3-2K8kfr-1}}}\moddef{Reduce: Maximum Value~{\nwtagstyle{}\subpageref{NW2D7mP3-2K8kfr-1}}}\endmoddef\nwstartdeflinemarkup\nwenddeflinemarkup
for (final Entry<Integer, Integer> entry : candidates.entrySet()) \{
  if (cand == null || cand.getValue() < entry.getValue()) \{
    cand = entry;
  \}
\}
\nwnotused{Reduce: Maximum Value}\nwendcode{}\nwbegindocs{6}\nwdocspar

\nwenddocs{}\nwfilename{src/search-scheduling.nw}\nwbegindocs{0}\chapter{Scheduling Operations}
\label{search-scheduling}

\section{Insert New Event}

Insert the new event into the given schedule at the indicated position.

brem is given (remaining) schedule
bnew is new schedule
ipos is insertion position
stop is new event [ t, v, ls, lr ]

Three arraycopy: put event, put before ipos, put after ipos

\nwenddocs{}\nwbegincode{1}\sublabel{NW22SnOZ-4V87KO-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW22SnOZ-4V87KO-1}}}\moddef{Schedule: Insert~{\nwtagstyle{}\subpageref{NW22SnOZ-4V87KO-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwenddeflinemarkup
bnew = new int[(brem.length + 4)];
System.arraycopy(stop, 0, bnew, 4*ipos, 4);
System.arraycopy(brem, 0, bnew, 0, 4*ipos);
System.arraycopy(brem, 4*ipos, bnew, 4*(ipos + 1), brem.length - 4*ipos);
\nwused{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwendcode{}\nwbegindocs{2}\nwdocspar

%\section{Rearrange Existing Events}

\nwenddocs{}\nwfilename{src/search-schedules.nw}\nwbegindocs{0}\chapter{Schedule Selection}
\label{search-schedules}

\section{Check Capacity}

tbeg is time to start applying pick-up load, tend is time to end the load.

\nwenddocs{}\nwbegincode{1}\sublabel{NW9CtVI-2UeEeu-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW9CtVI-2UeEeu-1}}}\moddef{Schedule Selection: Check Capacity~{\nwtagstyle{}\subpageref{NW9CtVI-2UeEeu-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwenddeflinemarkup
ok = (this.communicator.queryServerCapacityViolations(sid, rq, tbeg, tend)[0] == 0);
\nwused{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwendcode{}\nwbegindocs{2}\nwdocspar

\section{Check Time Window}

\nwenddocs{}\nwbegincode{3}\sublabel{NW9CtVI-fUjQA-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW9CtVI-fUjQA-1}}}\moddef{Schedule Selection: Check Time Window~{\nwtagstyle{}\subpageref{NW9CtVI-fUjQA-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwenddeflinemarkup
for (int _i = 0; _i < (bnew.length - 3); _i += 4) \{
  int _rid = bnew[(_i + 3)];
  int _rt  = bnew[(_i)];
  if (_rid != 0) \{
    int[] _u = this.communicator.queryUser(_rid);
    int _ue = _u[2];
    int _ul = _u[3];
    if (_rt < _ue || _rt > _ul) \{
      ok = false;
      break;
    \}
  \}
\}
\nwused{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwendcode{}\nwbegindocs{4}\nwdocspar

% \section{Cost-Based Selection}

\nwenddocs{}\nwfilename{src/search-routing.nw}\nwbegindocs{0}\chapter{Routing Operations}
\label{search-routing}

\section{Shortest Path}

\nwenddocs{}\nwbegincode{1}\sublabel{NW3gyy2C-1CU8MM-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW3gyy2C-1CU8MM-1}}}\moddef{Route: Shortest Path~{\nwtagstyle{}\subpageref{NW3gyy2C-1CU8MM-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwenddeflinemarkup
\{
  \LA{}Shortest: Step 1: Initialize~{\nwtagstyle{}\subpageref{NW3gyy2C-3lMPNM-1}}\RA{}
  \LA{}Shortest: Step 2: Compute~{\nwtagstyle{}\subpageref{NW3gyy2C-2EZ2CY-1}}\RA{}
  \LA{}Shortest: Step 3: Join~{\nwtagstyle{}\subpageref{NW3gyy2C-1OT4xQ-1}}\RA{}
  \LA{}Shortest: Step 4: Fill~{\nwtagstyle{}\subpageref{NW3gyy2C-1nl6rv-1}}\RA{}
\}
\nwused{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwendcode{}\nwbegindocs{2}\nwdocspar

\nwenddocs{}\nwbegincode{3}\sublabel{NW3gyy2C-3lMPNM-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW3gyy2C-3lMPNM-1}}}\moddef{Shortest: Step 1: Initialize~{\nwtagstyle{}\subpageref{NW3gyy2C-3lMPNM-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW3gyy2C-1CU8MM-1}}\nwenddeflinemarkup
final int _p = (bnew.length/4);
final int[][] _legs = new int[_p][];

int[] _leg = this.tools.computeRoute(wbeg[1], bnew[1], wbeg[0]);
int _n = _leg.length;
int _t = _leg[(_n - 2)];

_legs[0] = _leg;
\nwused{\\{NW3gyy2C-1CU8MM-1}}\nwendcode{}\nwbegindocs{4}\nwdocspar

\nwenddocs{}\nwbegincode{5}\sublabel{NW3gyy2C-2EZ2CY-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW3gyy2C-2EZ2CY-1}}}\moddef{Shortest: Step 2: Compute~{\nwtagstyle{}\subpageref{NW3gyy2C-2EZ2CY-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW3gyy2C-1CU8MM-1}}\nwenddeflinemarkup
for (int _i = 1; _i < _p; _i++) \{
  // Extract vertices
  final int _u = bnew[(4*_i - 3)];
  final int _v = bnew[(4*_i + 1)];
  // Compute path and store into _legs
  _leg = this.tools.computeRoute(_u, _v, _t);
  _legs[_i] = _leg;
  // Update _n and _t
  _n += (_leg.length - 2);
  _t = _leg[_leg.length - 2];
\}
\nwused{\\{NW3gyy2C-1CU8MM-1}}\nwendcode{}\nwbegindocs{6}\nwdocspar

\nwenddocs{}\nwbegincode{7}\sublabel{NW3gyy2C-1OT4xQ-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW3gyy2C-1OT4xQ-1}}}\moddef{Shortest: Step 3: Join~{\nwtagstyle{}\subpageref{NW3gyy2C-1OT4xQ-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW3gyy2C-1CU8MM-1}}\nwenddeflinemarkup
wnew = new int[_n];
int _k = 0;
for (int _i = 0; _i < _legs.length; _i++) \{
  final int _rend = (_legs[_i].length - (_i == (_legs.length - 1) ? 0 : 2));
  for (int _j = 0; _j < _rend; _j++) \{
    wnew[_k] = _legs[_i][_j];
    _k++;
  \}
\}
\nwused{\\{NW3gyy2C-1CU8MM-1}}\nwendcode{}\nwbegindocs{8}\nwdocspar

\nwenddocs{}\nwbegincode{9}\sublabel{NW3gyy2C-1nl6rv-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW3gyy2C-1nl6rv-1}}}\moddef{Shortest: Step 4: Fill~{\nwtagstyle{}\subpageref{NW3gyy2C-1nl6rv-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW3gyy2C-1CU8MM-1}}\nwenddeflinemarkup
for (int _i = 1; _i < _legs.length; _i++) \{
  bnew[(4*_i - 4)] = _legs[_i][0];
\}
bnew[(4*_p - 4)] = _t;
\nwused{\\{NW3gyy2C-1CU8MM-1}}\nwendcode{}\nwbegindocs{10}\nwdocspar

% \section{Longest Path}
% \section{Average Path}

\nwenddocs{}\nwfilename{src/search-routes.nw}\nwbegindocs{0}\chapter{Route Selection}
\label{search-routes}

\nwenddocs{}\nwfilename{src/search-algorithms.nw}\nwbegindocs{0}\chapter{Example Algorithms}
\label{search-algorithms}

\section{Nearest Neighbor}

\nwenddocs{}\nwbegincode{1}\sublabel{NW2W5UTV-QNBZk-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW2W5UTV-QNBZk-1}}}\moddef{NearestNeighbor.java~{\nwtagstyle{}\subpageref{NW2W5UTV-QNBZk-1}}}\endmoddef\nwstartdeflinemarkup\nwenddeflinemarkup
package com.github.jargors.client;
\LA{}NearestNeighbor: preamble~{\nwtagstyle{}\subpageref{NW2W5UTV-18lzwh-1}}\RA{}
public class NearestNeighbor extends Client \{
  final int MAX_PROXIMITY = 1800;
  public void init() \{
    System.out.printf("Set MAX_PROXIMITY=%d\\n", MAX_PROXIMITY);
  \}
  protected \LA{}NearestNeighbor: handleRequest(1)~{\nwtagstyle{}\subpageref{NW2W5UTV-16KpI3-1}}\RA{}
\}
\nwnotused{NearestNeighbor.java}\nwendcode{}\nwbegindocs{2}\nwdocspar

\nwenddocs{}\nwbegincode{3}\sublabel{NW2W5UTV-18lzwh-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW2W5UTV-18lzwh-1}}}\moddef{NearestNeighbor: preamble~{\nwtagstyle{}\subpageref{NW2W5UTV-18lzwh-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW2W5UTV-QNBZk-1}}\nwenddeflinemarkup
import com.github.jargors.sim.*;
import java.util.Arrays;
import java.util.Map;
import java.util.Map.Entry;
import java.util.HashMap;
\nwused{\\{NW2W5UTV-QNBZk-1}}\nwendcode{}\nwbegindocs{4}\nwdocspar

\nwenddocs{}\nwbegincode{5}\sublabel{NW2W5UTV-16KpI3-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW2W5UTV-16KpI3-1}}}\moddef{NearestNeighbor: handleRequest(1)~{\nwtagstyle{}\subpageref{NW2W5UTV-16KpI3-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW2W5UTV-QNBZk-1}}\nwenddeflinemarkup
void handleRequest(int[] r) throws ClientException, ClientFatalException \{
  \LA{}Debug: print request~{\nwtagstyle{}\subpageref{NW3ZDnOU-HVWtO-1}}\RA{}
  try \{
    final int rid = r[0];
    final int rq  = r[1];
    final int ro  = r[4];
    final int rd  = r[5];

    Map<Integer, Integer> candidates = new HashMap<Integer, Integer>(lut);
    Map<Integer, Integer> results = new HashMap<Integer, Integer>();
    \LA{}Debug: print candidates~{\nwtagstyle{}\subpageref{NW3ZDnOU-3B7sph-1}}\RA{}

    \LA{}Map/Filter: Proximity~{\nwtagstyle{}\subpageref{NWEBrBs-4AhmPL-1}}\RA{}
    candidates = new HashMap<Integer, Integer>(results);
    \LA{}Debug: map/filter: proximity~{\nwtagstyle{}\subpageref{NW3ZDnOU-1KKA0d-1}}\RA{}
    \LA{}Debug: print candidates~{\nwtagstyle{}\subpageref{NW3ZDnOU-3B7sph-1}}\RA{}

    // Remember minimum schedule, route, cost, server
    int[] wmin = null;
    int[] bmin = null;
    int cmin = Integer.MAX_VALUE;
    int smin = 0;

    while (!candidates.isEmpty()) \{

      Entry<Integer, Integer> cand = null;
      \LA{}Reduce: Minimum Value~{\nwtagstyle{}\subpageref{NW2D7mP3-YFiQd-1}}\RA{}
      \LA{}Debug: print candidate~{\nwtagstyle{}\subpageref{NW3ZDnOU-MmR2q-1}}\RA{}

      final int sid = cand.getKey();
      final int now = this.communicator.retrieveClock();

      int[] brem = this.communicator.queryServerScheduleRemaining(sid, now);
      \LA{}Debug: print brem~{\nwtagstyle{}\subpageref{NW3ZDnOU-JSCdp-1}}\RA{}

      final int[] wact = this.communicator.queryServerRouteActive(sid);
      \LA{}Debug: print wact~{\nwtagstyle{}\subpageref{NW3ZDnOU-4aj6aA-1}}\RA{}

      int[] wbeg = (wact[3] == 0
          ? new int[] \{ now    , wact[1] \}
          : new int[] \{ wact[2], wact[3] \});
      \LA{}Debug: print wbeg~{\nwtagstyle{}\subpageref{NW3ZDnOU-2EsvK6-1}}\RA{}

      // if next events occurs at next waypoint and is not server's own
      // destination, then delete these events from schedule (limitation #4).
      if (brem[2] != sid && brem[0] == wact[2]) \{
        \LA{}Debug: echo limitation 4~{\nwtagstyle{}\subpageref{NW3ZDnOU-4ZeXS0-1}}\RA{}
        while (brem[0] == wact[2]) \{
          brem = Arrays.copyOfRange(brem, 4, brem.length);
          \LA{}Debug: echo remove event~{\nwtagstyle{}\subpageref{NW3ZDnOU-34iFF1-1}}\RA{}
          \LA{}Debug: print brem~{\nwtagstyle{}\subpageref{NW3ZDnOU-JSCdp-1}}\RA{}
        \}
      \}

      int imax = (brem.length/4);
      int jmax = imax;
      int cost = brem[(brem.length - 4)];
      \LA{}Debug: print imax, jmax, cost~{\nwtagstyle{}\subpageref{NW3ZDnOU-40f0Up-1}}\RA{}

      final int[] bold = brem;

      // Try all insertion positions
      \LA{}Debug: echo start insertion heuristic~{\nwtagstyle{}\subpageref{NW3ZDnOU-1piQ1l-1}}\RA{}
      for (int i = 0; i < imax; i++) \{
        int tbeg = (i == 0 ? now : brem[4*(i - 1)]);

        for (int j = i; j < jmax; j++) \{
          int tend = bold[4*j];

          \LA{}Debug: print i, j~{\nwtagstyle{}\subpageref{NW3ZDnOU-30mX6u-1}}\RA{}
          \LA{}Debug: print tbeg, tend~{\nwtagstyle{}\subpageref{NW3ZDnOU-1VOGcH-1}}\RA{}

          boolean ok = false;

          \LA{}Debug: echo check capacity~{\nwtagstyle{}\subpageref{NW3ZDnOU-2Coo86-1}}\RA{}
          \LA{}Schedule Selection: Check Capacity~{\nwtagstyle{}\subpageref{NW9CtVI-2UeEeu-1}}\RA{}
          \LA{}Debug: print ok~{\nwtagstyle{}\subpageref{NW3ZDnOU-2Hm6y-1}}\RA{}

          if (ok) \{
            brem = bold.clone();  // reset to original
            int[] bnew = new int[] \{ \};

            int[] stop = new int[] \{ 0, ro, 0, rid \};
            int ipos = i;
            \LA{}Debug: print stop~{\nwtagstyle{}\subpageref{NW3ZDnOU-3b2tUV-1}}\RA{}
            \LA{}Debug: print ipos~{\nwtagstyle{}\subpageref{NW3ZDnOU-1BeOIe-1}}\RA{}
            \LA{}Schedule: Insert~{\nwtagstyle{}\subpageref{NW22SnOZ-4V87KO-1}}\RA{}
            \LA{}Debug: print bnew~{\nwtagstyle{}\subpageref{NW3ZDnOU-2EstFd-1}}\RA{}

            brem = bnew;

            stop[1] = rd;
            ipos = (j + 1);
            \LA{}Debug: print stop~{\nwtagstyle{}\subpageref{NW3ZDnOU-3b2tUV-1}}\RA{}
            \LA{}Debug: print ipos~{\nwtagstyle{}\subpageref{NW3ZDnOU-1BeOIe-1}}\RA{}
            \LA{}Schedule: Insert~{\nwtagstyle{}\subpageref{NW22SnOZ-4V87KO-1}}\RA{}
            \LA{}Debug: print bnew~{\nwtagstyle{}\subpageref{NW3ZDnOU-2EstFd-1}}\RA{}

            int[] wnew = null;

            \LA{}Route: Shortest Path~{\nwtagstyle{}\subpageref{NW3gyy2C-1CU8MM-1}}\RA{}

            // if next waypoint is vehicle destination,
            // reset route start time to last-visited time
            if (wact[3] == 0) \{
              wnew[0] = lut.get(sid);
            \}

            \LA{}Debug: print wnew~{\nwtagstyle{}\subpageref{NW3ZDnOU-28quig-1}}\RA{}

            \LA{}Debug: echo check time window~{\nwtagstyle{}\subpageref{NW3ZDnOU-IruGu-1}}\RA{}
            \LA{}Schedule Selection: Check Time Window~{\nwtagstyle{}\subpageref{NW9CtVI-fUjQA-1}}\RA{}
            \LA{}Debug: print ok~{\nwtagstyle{}\subpageref{NW3ZDnOU-2Hm6y-1}}\RA{}

            if (ok) \{
              int cdel = bnew[(bnew.length - 4)] - cost;
              if (cdel < cmin) \{
                bmin = bnew;
                wmin = wnew;
                cmin = cdel;
                smin = sid;
                \LA{}Debug: print bnew~{\nwtagstyle{}\subpageref{NW3ZDnOU-2EstFd-1}}\RA{}
                \LA{}Debug: print cmin~{\nwtagstyle{}\subpageref{NW3ZDnOU-2ty1Mu-1}}\RA{}
              \}
            \}

          \}
        \}
      \}
      \LA{}Debug: echo end insertion heuristic~{\nwtagstyle{}\subpageref{NW3ZDnOU-kwxOS-1}}\RA{}

      candidates.remove(sid);
      \LA{}Debug: print remove candidate~{\nwtagstyle{}\subpageref{NW3ZDnOU-1BQUqJ-1}}\RA{}

      if (smin != 0) \{
        this.communicator.updateServerService(smin, wmin, bmin,
            new int[] \{ rid \}, new int[] \{ \});
        break;
      \}
    \}
  \} catch (Exception e) \{
    throw new ClientException(e);
  \}
\}
\nwused{\\{NW2W5UTV-QNBZk-1}}\nwendcode{}\nwbegindocs{6}\nwdocspar

\section{Greedy Insertion}

\nwenddocs{}\nwbegincode{7}\sublabel{NW2W5UTV-1Tuf6f-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW2W5UTV-1Tuf6f-1}}}\moddef{GreedyInsertion.java~{\nwtagstyle{}\subpageref{NW2W5UTV-1Tuf6f-1}}}\endmoddef\nwstartdeflinemarkup\nwenddeflinemarkup
package com.github.jargors.client;
\LA{}GreedyInsertion: preamble~{\nwtagstyle{}\subpageref{NW2W5UTV-2erqlI-1}}\RA{}
public class GreedyInsertion extends Client \{
  final int MAX_PROXIMITY = 1800;
  public void init() \{
    System.out.printf("Set MAX_PROXIMITY=%d\\n", MAX_PROXIMITY);
  \}
  protected \LA{}GreedyInsertion: handleRequest(1)~{\nwtagstyle{}\subpageref{NW2W5UTV-2OWvsM-1}}\RA{}
\}
\nwnotused{GreedyInsertion.java}\nwendcode{}\nwbegindocs{8}\nwdocspar

\nwenddocs{}\nwbegincode{9}\sublabel{NW2W5UTV-2erqlI-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW2W5UTV-2erqlI-1}}}\moddef{GreedyInsertion: preamble~{\nwtagstyle{}\subpageref{NW2W5UTV-2erqlI-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW2W5UTV-1Tuf6f-1}\\{NW2W5UTV-2phINB-1}}\nwenddeflinemarkup
import com.github.jargors.sim.*;
import java.util.Arrays;
import java.util.Map;
import java.util.Map.Entry;
import java.util.HashMap;
\nwused{\\{NW2W5UTV-1Tuf6f-1}\\{NW2W5UTV-2phINB-1}}\nwendcode{}\nwbegindocs{10}\nwdocspar

\nwenddocs{}\nwbegincode{11}\sublabel{NW2W5UTV-2OWvsM-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW2W5UTV-2OWvsM-1}}}\moddef{GreedyInsertion: handleRequest(1)~{\nwtagstyle{}\subpageref{NW2W5UTV-2OWvsM-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW2W5UTV-1Tuf6f-1}}\nwenddeflinemarkup
void handleRequest(int[] r) throws ClientException, ClientFatalException \{
  \LA{}Debug: print request~{\nwtagstyle{}\subpageref{NW3ZDnOU-HVWtO-1}}\RA{}
  try \{
    final int rid = r[0];
    final int rq  = r[1];
    final int ro  = r[4];
    final int rd  = r[5];

    Map<Integer, Integer> candidates = new HashMap<Integer, Integer>(lut);
    Map<Integer, Integer> results = new HashMap<Integer, Integer>();
    \LA{}Debug: print candidates~{\nwtagstyle{}\subpageref{NW3ZDnOU-3B7sph-1}}\RA{}

    \LA{}Map/Filter: Proximity~{\nwtagstyle{}\subpageref{NWEBrBs-4AhmPL-1}}\RA{}
    candidates = new HashMap<Integer, Integer>(results);
    \LA{}Debug: map/filter: proximity~{\nwtagstyle{}\subpageref{NW3ZDnOU-1KKA0d-1}}\RA{}
    \LA{}Debug: print candidates~{\nwtagstyle{}\subpageref{NW3ZDnOU-3B7sph-1}}\RA{}

    // Remember minimum schedule, route, cost, server
    int[] wmin = null;
    int[] bmin = null;
    int cmin = Integer.MAX_VALUE;
    int smin = 0;

    while (!candidates.isEmpty()) \{

      Entry<Integer, Integer> cand = null;
      \LA{}Reduce: Minimum Value~{\nwtagstyle{}\subpageref{NW2D7mP3-YFiQd-1}}\RA{}
      \LA{}Debug: print candidate~{\nwtagstyle{}\subpageref{NW3ZDnOU-MmR2q-1}}\RA{}

      final int sid = cand.getKey();
      final int now = this.communicator.retrieveClock();

      int[] brem = this.communicator.queryServerScheduleRemaining(sid, now);
      \LA{}Debug: print brem~{\nwtagstyle{}\subpageref{NW3ZDnOU-JSCdp-1}}\RA{}

      final int[] wact = this.communicator.queryServerRouteActive(sid);
      \LA{}Debug: print wact~{\nwtagstyle{}\subpageref{NW3ZDnOU-4aj6aA-1}}\RA{}

      int[] wbeg = (wact[3] == 0
          ? new int[] \{ now    , wact[1] \}
          : new int[] \{ wact[2], wact[3] \});
      \LA{}Debug: print wbeg~{\nwtagstyle{}\subpageref{NW3ZDnOU-2EsvK6-1}}\RA{}

      // if next events occurs at next waypoint and is not server's own
      // destination, then delete these events from schedule (limitation #4).
      if (brem[2] != sid && brem[0] == wact[2]) \{
        \LA{}Debug: echo limitation 4~{\nwtagstyle{}\subpageref{NW3ZDnOU-4ZeXS0-1}}\RA{}
        while (brem[0] == wact[2]) \{
          brem = Arrays.copyOfRange(brem, 4, brem.length);
          \LA{}Debug: echo remove event~{\nwtagstyle{}\subpageref{NW3ZDnOU-34iFF1-1}}\RA{}
          \LA{}Debug: print brem~{\nwtagstyle{}\subpageref{NW3ZDnOU-JSCdp-1}}\RA{}
        \}
      \}

      int imax = (brem.length/4);
      int jmax = imax;
      int cost = brem[(brem.length - 4)];
      \LA{}Debug: print imax, jmax, cost~{\nwtagstyle{}\subpageref{NW3ZDnOU-40f0Up-1}}\RA{}

      final int[] bold = brem;

      // Try all insertion positions
      \LA{}Debug: echo start insertion heuristic~{\nwtagstyle{}\subpageref{NW3ZDnOU-1piQ1l-1}}\RA{}
      for (int i = 0; i < imax; i++) \{
        int tbeg = (i == 0 ? now : brem[4*(i - 1)]);

        for (int j = i; j < jmax; j++) \{
          int tend = bold[4*j];

          \LA{}Debug: print i, j~{\nwtagstyle{}\subpageref{NW3ZDnOU-30mX6u-1}}\RA{}
          \LA{}Debug: print tbeg, tend~{\nwtagstyle{}\subpageref{NW3ZDnOU-1VOGcH-1}}\RA{}

          boolean ok = false;

          \LA{}Debug: echo check capacity~{\nwtagstyle{}\subpageref{NW3ZDnOU-2Coo86-1}}\RA{}
          \LA{}Schedule Selection: Check Capacity~{\nwtagstyle{}\subpageref{NW9CtVI-2UeEeu-1}}\RA{}
          \LA{}Debug: print ok~{\nwtagstyle{}\subpageref{NW3ZDnOU-2Hm6y-1}}\RA{}

          if (ok) \{
            brem = bold.clone();  // reset to original
            int[] bnew = new int[] \{ \};

            int[] stop = new int[] \{ 0, ro, 0, rid \};
            int ipos = i;
            \LA{}Debug: print stop~{\nwtagstyle{}\subpageref{NW3ZDnOU-3b2tUV-1}}\RA{}
            \LA{}Debug: print ipos~{\nwtagstyle{}\subpageref{NW3ZDnOU-1BeOIe-1}}\RA{}
            \LA{}Schedule: Insert~{\nwtagstyle{}\subpageref{NW22SnOZ-4V87KO-1}}\RA{}
            \LA{}Debug: print bnew~{\nwtagstyle{}\subpageref{NW3ZDnOU-2EstFd-1}}\RA{}

            brem = bnew;

            stop[1] = rd;
            ipos = (j + 1);
            \LA{}Debug: print stop~{\nwtagstyle{}\subpageref{NW3ZDnOU-3b2tUV-1}}\RA{}
            \LA{}Debug: print ipos~{\nwtagstyle{}\subpageref{NW3ZDnOU-1BeOIe-1}}\RA{}
            \LA{}Schedule: Insert~{\nwtagstyle{}\subpageref{NW22SnOZ-4V87KO-1}}\RA{}
            \LA{}Debug: print bnew~{\nwtagstyle{}\subpageref{NW3ZDnOU-2EstFd-1}}\RA{}

            int[] wnew = null;

            \LA{}Route: Shortest Path~{\nwtagstyle{}\subpageref{NW3gyy2C-1CU8MM-1}}\RA{}

            // if next waypoint is vehicle destination,
            // reset route start time to last-visited time
            if (wact[3] == 0) \{
              wnew[0] = lut.get(sid);
            \}

            \LA{}Debug: print wnew~{\nwtagstyle{}\subpageref{NW3ZDnOU-28quig-1}}\RA{}

            \LA{}Debug: echo check time window~{\nwtagstyle{}\subpageref{NW3ZDnOU-IruGu-1}}\RA{}
            \LA{}Schedule Selection: Check Time Window~{\nwtagstyle{}\subpageref{NW9CtVI-fUjQA-1}}\RA{}
            \LA{}Debug: print ok~{\nwtagstyle{}\subpageref{NW3ZDnOU-2Hm6y-1}}\RA{}

            if (ok) \{
              int cdel = bnew[(bnew.length - 4)] - cost;
              if (cdel < cmin) \{
                bmin = bnew;
                wmin = wnew;
                cmin = cdel;
                smin = sid;
                \LA{}Debug: print bnew~{\nwtagstyle{}\subpageref{NW3ZDnOU-2EstFd-1}}\RA{}
                \LA{}Debug: print cmin~{\nwtagstyle{}\subpageref{NW3ZDnOU-2ty1Mu-1}}\RA{}
              \}
            \}

          \}
        \}
      \}
      \LA{}Debug: echo end insertion heuristic~{\nwtagstyle{}\subpageref{NW3ZDnOU-kwxOS-1}}\RA{}

      candidates.remove(sid);
      \LA{}Debug: print remove candidate~{\nwtagstyle{}\subpageref{NW3ZDnOU-1BQUqJ-1}}\RA{}
    \}

    \LA{}Debug: print candidates~{\nwtagstyle{}\subpageref{NW3ZDnOU-3B7sph-1}}\RA{}

    if (smin != 0) \{
      this.communicator.updateServerService(smin, wmin, bmin,
          new int[] \{ rid \}, new int[] \{ \});
    \}
  \} catch (Exception e) \{
    throw new ClientException(e);
  \}
\}
\nwused{\\{NW2W5UTV-1Tuf6f-1}}\nwendcode{}\nwbegindocs{12}\nwdocspar

\section{Greedy Insertion with Fallback}

\nwenddocs{}\nwbegincode{13}\sublabel{NW2W5UTV-2phINB-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW2W5UTV-2phINB-1}}}\moddef{GreedyInsertionFallback.java~{\nwtagstyle{}\subpageref{NW2W5UTV-2phINB-1}}}\endmoddef\nwstartdeflinemarkup\nwenddeflinemarkup
package com.github.jargors.client;
\LA{}GreedyInsertion: preamble~{\nwtagstyle{}\subpageref{NW2W5UTV-2erqlI-1}}\RA{}
public class GreedyInsertionFallback extends Client \{
  final int MAX_PROXIMITY = 1800;
  final int MAX_SCHEDULE_LENGTH = 8;
  final int QUEUE_THRESHOLD = 30;
  public void init() \{
    System.out.printf("Set MAX_PROXIMITY=%d\\n", MAX_PROXIMITY);
  \}
  protected \LA{}GreedyInsertionFallback: handleRequest(1)~{\nwtagstyle{}\subpageref{NW2W5UTV-4ZdLuY-1}}\RA{}
\}
\nwnotused{GreedyInsertionFallback.java}\nwendcode{}\nwbegindocs{14}\nwdocspar

\nwenddocs{}\nwbegincode{15}\sublabel{NW2W5UTV-4ZdLuY-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW2W5UTV-4ZdLuY-1}}}\moddef{GreedyInsertionFallback: handleRequest(1)~{\nwtagstyle{}\subpageref{NW2W5UTV-4ZdLuY-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW2W5UTV-2phINB-1}}\nwenddeflinemarkup
void handleRequest(int[] r) throws ClientException, ClientFatalException \{
  \LA{}Debug: print request~{\nwtagstyle{}\subpageref{NW3ZDnOU-HVWtO-1}}\RA{}
  try \{
    final int rid = r[0];
    final int rq  = r[1];
    final int ro  = r[4];
    final int rd  = r[5];

    Map<Integer, Integer> candidates = new HashMap<Integer, Integer>(lut);
    Map<Integer, Integer> results = new HashMap<Integer, Integer>();
    \LA{}Debug: print candidates~{\nwtagstyle{}\subpageref{NW3ZDnOU-3B7sph-1}}\RA{}

    // Quite slow!
    /*
    \LA{}Map/Filter: Schedule Length~{\nwtagstyle{}\subpageref{NWEBrBs-3tu5Lh-1}}\RA{}
    candidates = new HashMap<Integer, Integer>(results);
    \LA{}Debug: map/filter: schedule length~{\nwtagstyle{}\subpageref{NW3ZDnOU-2WwrvE-1}}\RA{}
    \LA{}Debug: print candidates~{\nwtagstyle{}\subpageref{NW3ZDnOU-3B7sph-1}}\RA{}
    */

    results.clear();
    \LA{}Map/Filter: Proximity~{\nwtagstyle{}\subpageref{NWEBrBs-4AhmPL-1}}\RA{}
    candidates = new HashMap<Integer, Integer>(results);
    \LA{}Debug: map/filter: proximity~{\nwtagstyle{}\subpageref{NW3ZDnOU-1KKA0d-1}}\RA{}
    \LA{}Debug: print candidates~{\nwtagstyle{}\subpageref{NW3ZDnOU-3B7sph-1}}\RA{}

    // Remember minimum schedule, route, cost, server
    int[] wmin = null;
    int[] bmin = null;
    int cmin = Integer.MAX_VALUE;
    int smin = 0;

    boolean fallback = (this.queue.size() > QUEUE_THRESHOLD);
    \LA{}Debug: print queue size~{\nwtagstyle{}\subpageref{NW3ZDnOU-8YBCE-1}}\RA{}
    \LA{}Debug: echo fallback~{\nwtagstyle{}\subpageref{NW3ZDnOU-3IJWHX-1}}\RA{}

    while (!candidates.isEmpty()) \{

      Entry<Integer, Integer> cand = null;
      \LA{}Reduce: Minimum Value~{\nwtagstyle{}\subpageref{NW2D7mP3-YFiQd-1}}\RA{}
      \LA{}Debug: print candidate~{\nwtagstyle{}\subpageref{NW3ZDnOU-MmR2q-1}}\RA{}

      final int sid = cand.getKey();
      final int now = this.communicator.retrieveClock();

      int[] brem = this.communicator.queryServerScheduleRemaining(sid, now);
      \LA{}Debug: print brem~{\nwtagstyle{}\subpageref{NW3ZDnOU-JSCdp-1}}\RA{}

      if (brem.length/4 > MAX_SCHEDULE_LENGTH) \{
        candidates.remove(sid);
        continue;
      \}

      final int[] wact = this.communicator.queryServerRouteActive(sid);
      \LA{}Debug: print wact~{\nwtagstyle{}\subpageref{NW3ZDnOU-4aj6aA-1}}\RA{}

      int[] wbeg = (wact[3] == 0
          ? new int[] \{ now    , wact[1] \}
          : new int[] \{ wact[2], wact[3] \});
      \LA{}Debug: print wbeg~{\nwtagstyle{}\subpageref{NW3ZDnOU-2EsvK6-1}}\RA{}

      // if next events occurs at next waypoint and is not server's own
      // destination, then delete these events from schedule (limitation #4).
      if (brem[2] != sid && brem[0] == wact[2]) \{
        \LA{}Debug: echo limitation 4~{\nwtagstyle{}\subpageref{NW3ZDnOU-4ZeXS0-1}}\RA{}
        while (brem[0] == wact[2]) \{
          brem = Arrays.copyOfRange(brem, 4, brem.length);
          \LA{}Debug: echo remove event~{\nwtagstyle{}\subpageref{NW3ZDnOU-34iFF1-1}}\RA{}
          \LA{}Debug: print brem~{\nwtagstyle{}\subpageref{NW3ZDnOU-JSCdp-1}}\RA{}
        \}
      \}

      int imax = (brem.length/4);
      int jmax = imax;
      int cost = brem[(brem.length - 4)];
      \LA{}Debug: print imax, jmax, cost~{\nwtagstyle{}\subpageref{NW3ZDnOU-40f0Up-1}}\RA{}

      final int[] bold = brem;

      // Try all insertion positions
      \LA{}Debug: echo start insertion heuristic~{\nwtagstyle{}\subpageref{NW3ZDnOU-1piQ1l-1}}\RA{}
      for (int i = 0; i < imax; i++) \{
        int tbeg = (i == 0 ? now : brem[4*(i - 1)]);

        for (int j = i; j < jmax; j++) \{
          int tend = bold[4*j];

          \LA{}Debug: print i, j~{\nwtagstyle{}\subpageref{NW3ZDnOU-30mX6u-1}}\RA{}
          \LA{}Debug: print tbeg, tend~{\nwtagstyle{}\subpageref{NW3ZDnOU-1VOGcH-1}}\RA{}

          boolean ok = false;

          \LA{}Debug: echo check capacity~{\nwtagstyle{}\subpageref{NW3ZDnOU-2Coo86-1}}\RA{}
          \LA{}Schedule Selection: Check Capacity~{\nwtagstyle{}\subpageref{NW9CtVI-2UeEeu-1}}\RA{}
          \LA{}Debug: print ok~{\nwtagstyle{}\subpageref{NW3ZDnOU-2Hm6y-1}}\RA{}

          if (ok) \{
            brem = bold.clone();  // reset to original
            int[] bnew = new int[] \{ \};

            int[] stop = new int[] \{ 0, ro, 0, rid \};
            int ipos = i;
            \LA{}Debug: print stop~{\nwtagstyle{}\subpageref{NW3ZDnOU-3b2tUV-1}}\RA{}
            \LA{}Debug: print ipos~{\nwtagstyle{}\subpageref{NW3ZDnOU-1BeOIe-1}}\RA{}
            \LA{}Schedule: Insert~{\nwtagstyle{}\subpageref{NW22SnOZ-4V87KO-1}}\RA{}
            \LA{}Debug: print bnew~{\nwtagstyle{}\subpageref{NW3ZDnOU-2EstFd-1}}\RA{}

            brem = bnew;

            stop[1] = rd;
            ipos = (j + 1);
            \LA{}Debug: print stop~{\nwtagstyle{}\subpageref{NW3ZDnOU-3b2tUV-1}}\RA{}
            \LA{}Debug: print ipos~{\nwtagstyle{}\subpageref{NW3ZDnOU-1BeOIe-1}}\RA{}
            \LA{}Schedule: Insert~{\nwtagstyle{}\subpageref{NW22SnOZ-4V87KO-1}}\RA{}
            \LA{}Debug: print bnew~{\nwtagstyle{}\subpageref{NW3ZDnOU-2EstFd-1}}\RA{}

            int[] wnew = null;

            \LA{}Route: Shortest Path~{\nwtagstyle{}\subpageref{NW3gyy2C-1CU8MM-1}}\RA{}

            // if next waypoint is vehicle destination,
            // reset route start time to last-visited time
            if (wact[3] == 0) \{
              wnew[0] = lut.get(sid);
            \}

            \LA{}Debug: print wnew~{\nwtagstyle{}\subpageref{NW3ZDnOU-28quig-1}}\RA{}

            \LA{}Debug: echo check time window~{\nwtagstyle{}\subpageref{NW3ZDnOU-IruGu-1}}\RA{}
            \LA{}Schedule Selection: Check Time Window~{\nwtagstyle{}\subpageref{NW9CtVI-fUjQA-1}}\RA{}
            \LA{}Debug: print ok~{\nwtagstyle{}\subpageref{NW3ZDnOU-2Hm6y-1}}\RA{}

            if (ok) \{
              int cdel = bnew[(bnew.length - 4)] - cost;
              if (cdel < cmin) \{
                bmin = bnew;
                wmin = wnew;
                cmin = cdel;
                smin = sid;
                \LA{}Debug: print bnew~{\nwtagstyle{}\subpageref{NW3ZDnOU-2EstFd-1}}\RA{}
                \LA{}Debug: print cmin~{\nwtagstyle{}\subpageref{NW3ZDnOU-2ty1Mu-1}}\RA{}
              \}
            \}

          \}
        \}
      \}
      \LA{}Debug: echo end insertion heuristic~{\nwtagstyle{}\subpageref{NW3ZDnOU-kwxOS-1}}\RA{}

      candidates.remove(sid);
      \LA{}Debug: print remove candidate~{\nwtagstyle{}\subpageref{NW3ZDnOU-1BQUqJ-1}}\RA{}

      if (fallback && smin != 0) \{
        break;
      \}
    \}

    \LA{}Debug: print candidates~{\nwtagstyle{}\subpageref{NW3ZDnOU-3B7sph-1}}\RA{}

    if (smin != 0) \{
      this.communicator.updateServerService(smin, wmin, bmin,
          new int[] \{ rid \}, new int[] \{ \});
    \}

  \} catch (Exception e) \{
    throw new ClientException(e);
  \}
\}
\nwused{\\{NW2W5UTV-2phINB-1}}\nwendcode{}\nwbegindocs{16}\nwdocspar

\section{Nearest Perpendicular}

\nwenddocs{}\nwbegincode{17}\sublabel{NW2W5UTV-qLZ3e-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW2W5UTV-qLZ3e-1}}}\moddef{NearestPerpendicular.java~{\nwtagstyle{}\subpageref{NW2W5UTV-qLZ3e-1}}}\endmoddef\nwstartdeflinemarkup\nwenddeflinemarkup
package com.github.jargors.client;
\LA{}NearestPerpendicular: preamble~{\nwtagstyle{}\subpageref{NW2W5UTV-3pPKWW-1}}\RA{}
public class NearestPerpendicular extends Client \{
  final int MAX_PROXIMITY = 1800;
  final int ROUTE_SKIP_EVERY_N = 1;
  \LA{}Utilities: route cache~{\nwtagstyle{}\subpageref{NW2LUTbN-1rvh0k-1}}\RA{}
  public void init() \{
    System.out.printf("Set MAX_PROXIMITY=%d\\n", MAX_PROXIMITY);
  \}
  protected \LA{}NearestPerpendicular: handleRequest(1)~{\nwtagstyle{}\subpageref{NW2W5UTV-wXujK-1}}\RA{}
\}
\nwnotused{NearestPerpendicular.java}\nwendcode{}\nwbegindocs{18}\nwdocspar

\nwenddocs{}\nwbegincode{19}\sublabel{NW2W5UTV-3pPKWW-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW2W5UTV-3pPKWW-1}}}\moddef{NearestPerpendicular: preamble~{\nwtagstyle{}\subpageref{NW2W5UTV-3pPKWW-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW2W5UTV-qLZ3e-1}}\nwenddeflinemarkup
import com.github.jargors.sim.*;
import java.util.Arrays;
import java.util.Map;
import java.util.Map.Entry;
import java.util.HashMap;
\nwused{\\{NW2W5UTV-qLZ3e-1}}\nwendcode{}\nwbegindocs{20}\nwdocspar

\nwenddocs{}\nwbegincode{21}\sublabel{NW2W5UTV-wXujK-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW2W5UTV-wXujK-1}}}\moddef{NearestPerpendicular: handleRequest(1)~{\nwtagstyle{}\subpageref{NW2W5UTV-wXujK-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW2W5UTV-qLZ3e-1}}\nwenddeflinemarkup
void handleRequest(int[] r) throws ClientException, ClientFatalException \{
  \LA{}Debug: print request~{\nwtagstyle{}\subpageref{NW3ZDnOU-HVWtO-1}}\RA{}
  try \{
    final int rid = r[0];
    final int rq  = r[1];
    final int ro  = r[4];
    final int rd  = r[5];

    Map<Integer, Integer> candidates = new HashMap<Integer, Integer>(lut);
    Map<Integer, Integer> results = new HashMap<Integer, Integer>();
    \LA{}Debug: print candidates~{\nwtagstyle{}\subpageref{NW3ZDnOU-3B7sph-1}}\RA{}

    \LA{}Map/Filter: Proximity~{\nwtagstyle{}\subpageref{NWEBrBs-4AhmPL-1}}\RA{}
    candidates = new HashMap<Integer, Integer>(results);
    \LA{}Debug: map/filter: proximity~{\nwtagstyle{}\subpageref{NW3ZDnOU-1KKA0d-1}}\RA{}
    \LA{}Debug: print candidates~{\nwtagstyle{}\subpageref{NW3ZDnOU-3B7sph-1}}\RA{}

    results.clear();
    \LA{}Map/Filter: Perpendicular~{\nwtagstyle{}\subpageref{NWEBrBs-4C3qWe-1}}\RA{}
    candidates = new HashMap<Integer, Integer>(results);
    \LA{}Debug: map/filter: perpendicular~{\nwtagstyle{}\subpageref{NW3ZDnOU-1e6AJj-1}}\RA{}
    \LA{}Debug: print candidates~{\nwtagstyle{}\subpageref{NW3ZDnOU-3B7sph-1}}\RA{}

    // Remember minimum schedule, route, cost, server
    int[] wmin = null;
    int[] bmin = null;
    int cmin = Integer.MAX_VALUE;
    int smin = 0;

    while (!candidates.isEmpty()) \{

      Entry<Integer, Integer> cand = null;
      \LA{}Reduce: Minimum Value~{\nwtagstyle{}\subpageref{NW2D7mP3-YFiQd-1}}\RA{}
      \LA{}Debug: print candidate~{\nwtagstyle{}\subpageref{NW3ZDnOU-MmR2q-1}}\RA{}

      final int sid = cand.getKey();
      final int now = this.communicator.retrieveClock();

      int[] brem = this.communicator.queryServerScheduleRemaining(sid, now);
      \LA{}Debug: print brem~{\nwtagstyle{}\subpageref{NW3ZDnOU-JSCdp-1}}\RA{}

      final int[] wact = this.communicator.queryServerRouteActive(sid);
      \LA{}Debug: print wact~{\nwtagstyle{}\subpageref{NW3ZDnOU-4aj6aA-1}}\RA{}

      int[] wbeg = (wact[3] == 0
          ? new int[] \{ now    , wact[1] \}
          : new int[] \{ wact[2], wact[3] \});
      \LA{}Debug: print wbeg~{\nwtagstyle{}\subpageref{NW3ZDnOU-2EsvK6-1}}\RA{}

      // if next events occurs at next waypoint and is not server's own
      // destination, then delete these events from schedule (limitation #4).
      if (brem[2] != sid && brem[0] == wact[2]) \{
        \LA{}Debug: echo limitation 4~{\nwtagstyle{}\subpageref{NW3ZDnOU-4ZeXS0-1}}\RA{}
        while (brem[0] == wact[2]) \{
          brem = Arrays.copyOfRange(brem, 4, brem.length);
          \LA{}Debug: echo remove event~{\nwtagstyle{}\subpageref{NW3ZDnOU-34iFF1-1}}\RA{}
          \LA{}Debug: print brem~{\nwtagstyle{}\subpageref{NW3ZDnOU-JSCdp-1}}\RA{}
        \}
      \}

      int imax = (brem.length/4);
      int jmax = imax;
      int cost = brem[(brem.length - 4)];
      \LA{}Debug: print imax, jmax, cost~{\nwtagstyle{}\subpageref{NW3ZDnOU-40f0Up-1}}\RA{}

      final int[] bold = brem;

      // Try all insertion positions
      \LA{}Debug: echo start insertion heuristic~{\nwtagstyle{}\subpageref{NW3ZDnOU-1piQ1l-1}}\RA{}
      for (int i = 0; i < imax; i++) \{
        int tbeg = (i == 0 ? now : brem[4*(i - 1)]);

        for (int j = i; j < jmax; j++) \{
          int tend = bold[4*j];

          \LA{}Debug: print i, j~{\nwtagstyle{}\subpageref{NW3ZDnOU-30mX6u-1}}\RA{}
          \LA{}Debug: print tbeg, tend~{\nwtagstyle{}\subpageref{NW3ZDnOU-1VOGcH-1}}\RA{}

          boolean ok = false;

          \LA{}Debug: echo check capacity~{\nwtagstyle{}\subpageref{NW3ZDnOU-2Coo86-1}}\RA{}
          \LA{}Schedule Selection: Check Capacity~{\nwtagstyle{}\subpageref{NW9CtVI-2UeEeu-1}}\RA{}
          \LA{}Debug: print ok~{\nwtagstyle{}\subpageref{NW3ZDnOU-2Hm6y-1}}\RA{}

          if (ok) \{
            brem = bold.clone();  // reset to original
            int[] bnew = new int[] \{ \};

            int[] stop = new int[] \{ 0, ro, 0, rid \};
            int ipos = i;
            \LA{}Debug: print stop~{\nwtagstyle{}\subpageref{NW3ZDnOU-3b2tUV-1}}\RA{}
            \LA{}Debug: print ipos~{\nwtagstyle{}\subpageref{NW3ZDnOU-1BeOIe-1}}\RA{}
            \LA{}Schedule: Insert~{\nwtagstyle{}\subpageref{NW22SnOZ-4V87KO-1}}\RA{}
            \LA{}Debug: print bnew~{\nwtagstyle{}\subpageref{NW3ZDnOU-2EstFd-1}}\RA{}

            brem = bnew;

            stop[1] = rd;
            ipos = (j + 1);
            \LA{}Debug: print stop~{\nwtagstyle{}\subpageref{NW3ZDnOU-3b2tUV-1}}\RA{}
            \LA{}Debug: print ipos~{\nwtagstyle{}\subpageref{NW3ZDnOU-1BeOIe-1}}\RA{}
            \LA{}Schedule: Insert~{\nwtagstyle{}\subpageref{NW22SnOZ-4V87KO-1}}\RA{}
            \LA{}Debug: print bnew~{\nwtagstyle{}\subpageref{NW3ZDnOU-2EstFd-1}}\RA{}

            int[] wnew = null;

            \LA{}Route: Shortest Path~{\nwtagstyle{}\subpageref{NW3gyy2C-1CU8MM-1}}\RA{}

            // if next waypoint is vehicle destination,
            // reset route start time to last-visited time
            if (wact[3] == 0) \{
              wnew[0] = lut.get(sid);
            \}

            \LA{}Debug: print wnew~{\nwtagstyle{}\subpageref{NW3ZDnOU-28quig-1}}\RA{}

            \LA{}Debug: echo check time window~{\nwtagstyle{}\subpageref{NW3ZDnOU-IruGu-1}}\RA{}
            \LA{}Schedule Selection: Check Time Window~{\nwtagstyle{}\subpageref{NW9CtVI-fUjQA-1}}\RA{}
            \LA{}Debug: print ok~{\nwtagstyle{}\subpageref{NW3ZDnOU-2Hm6y-1}}\RA{}

            if (ok) \{
              int cdel = bnew[(bnew.length - 4)] - cost;
              if (cdel < cmin) \{
                bmin = bnew;
                wmin = wnew;
                cmin = cdel;
                smin = sid;
                \LA{}Debug: print bnew~{\nwtagstyle{}\subpageref{NW3ZDnOU-2EstFd-1}}\RA{}
                \LA{}Debug: print cmin~{\nwtagstyle{}\subpageref{NW3ZDnOU-2ty1Mu-1}}\RA{}
              \}
            \}

          \}
        \}
      \}
      \LA{}Debug: echo end insertion heuristic~{\nwtagstyle{}\subpageref{NW3ZDnOU-kwxOS-1}}\RA{}

      candidates.remove(sid);
      \LA{}Debug: print remove candidate~{\nwtagstyle{}\subpageref{NW3ZDnOU-1BQUqJ-1}}\RA{}

      if (smin != 0) \{
        this.communicator.updateServerService(smin, wmin, bmin,
            new int[] \{ rid \}, new int[] \{ \});
        break;
      \}
    \}
  \} catch (Exception e) \{
    throw new ClientException(e);
  \}
\}
\nwused{\\{NW2W5UTV-qLZ3e-1}}\nwendcode{}\nwbegindocs{22}\nwdocspar
\nwenddocs{}\nwfilename{src/join-overview.nw}\nwbegindocs{0}\part{Join-Based Clients}
\label{part-join}

\chapter{Overview}
\label{join-overview}

This chapter gives an overview of join-based clients...

\nwenddocs{}\nwfilename{src/traffic-overview.nw}\nwbegindocs{0}\part{Traffic Functions}
\label{part-traffic}

\chapter{Overview}
\label{traffic-overview}

This chapter gives an overview of traffic functions...

\nwenddocs{}\nwfilename{src/traffic-broadway.nw}\nwbegindocs{0}\chapter{Traffic: Broadway}

\nwenddocs{}\nwbegincode{1}\sublabel{NW1QgbvE-3asg0V-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW1QgbvE-3asg0V-1}}}\moddef{Broadway.java~{\nwtagstyle{}\subpageref{NW1QgbvE-3asg0V-1}}}\endmoddef\nwstartdeflinemarkup\nwenddeflinemarkup
package com.github.jargors.traffic;
import com.github.jargors.sim.*;
import java.util.Map;
public class Broadway extends Traffic \{
  private Map<Integer, Integer> lu_broadway = Map.ofEntries(
    Map.entry(10024,6898),
    Map.entry(10071,7512),
    Map.entry(10109,11306),
    Map.entry(10298,4057),
    Map.entry(10342,9159),
    Map.entry(10378,10775),
    Map.entry(1041,1043),
    Map.entry(1043,5145),
    Map.entry(10506,11594),
    Map.entry(10517,10519),
    Map.entry(10519,3814),
    Map.entry(10565,9347),
    Map.entry(10572,3304),
    Map.entry(10628,6944),
    Map.entry(10671,10672),
    Map.entry(10672,326),
    Map.entry(10690,10691),
    Map.entry(10691,1994),
    Map.entry(10729,11922),
    Map.entry(10775,4882),
    Map.entry(10864,2072),
    Map.entry(10949,7023),
    Map.entry(10966,7019),
    Map.entry(10983,2568),
    Map.entry(11024,3875),
    Map.entry(11066,7349),
    Map.entry(11172,8494),
    Map.entry(11197,1893),
    Map.entry(11306,7781),
    Map.entry(11314,2490),
    Map.entry(11366,1216),
    Map.entry(11398,10342),
    Map.entry(11438,8502),
    Map.entry(11439,11398),
    Map.entry(1155,6168),
    Map.entry(11594,160),
    Map.entry(1162,2350),
    Map.entry(11922,10949),
    Map.entry(11930,7340),
    Map.entry(12,4286),
    Map.entry(12114,1239),
    Map.entry(1216,1218),
    Map.entry(1218,7106),
    Map.entry(1239,1241),
    Map.entry(1241,3383),
    Map.entry(1290,4347),
    Map.entry(1467,1469),
    Map.entry(1469,10628),
    Map.entry(1564,1565),
    Map.entry(1565,4163),
    Map.entry(160,161),
    Map.entry(161,8444),
    Map.entry(1732,1734),
    Map.entry(1734,1564),
    Map.entry(180,181),
    Map.entry(181,4284),
    Map.entry(1821,10671),
    Map.entry(1832,1833),
    Map.entry(1833,10864),
    Map.entry(1854,1855),
    Map.entry(1855,2920),
    Map.entry(1883,6805),
    Map.entry(1893,1894),
    Map.entry(1894,3858),
    Map.entry(1936,1937),
    Map.entry(1937,5830),
    Map.entry(1950,887),
    Map.entry(1994,632),
    Map.entry(2072,2073),
    Map.entry(2073,7294),
    Map.entry(2083,2084),
    Map.entry(2084,6989),
    Map.entry(2118,7558),
    Map.entry(2146,2147),
    Map.entry(2147,3515),
    Map.entry(218,219),
    Map.entry(219,11314),
    Map.entry(2194,2195),
    Map.entry(2195,8923),
    Map.entry(2252,4641),
    Map.entry(226,8293),
    Map.entry(2277,2278),
    Map.entry(2278,9841),
    Map.entry(2316,843),
    Map.entry(2323,2324),
    Map.entry(2324,8683),
    Map.entry(2350,12),
    Map.entry(2393,2394),
    Map.entry(2394,4693),
    Map.entry(2413,2083),
    Map.entry(2417,6),
    Map.entry(2418,2419),
    Map.entry(2419,6973),
    Map.entry(2458,1854),
    Map.entry(2468,2418),
    Map.entry(2490,2492),
    Map.entry(2492,4298),
    Map.entry(2568,2570),
    Map.entry(2570,10024),
    Map.entry(2615,10729),
    Map.entry(2680,1883),
    Map.entry(2750,2751),
    Map.entry(2751,3016),
    Map.entry(2888,12114),
    Map.entry(2920,2888),
    Map.entry(2928,2194),
    Map.entry(3011,3013),
    Map.entry(3013,2417),
    Map.entry(3016,4767),
    Map.entry(3024,9569),
    Map.entry(3107,1467),
    Map.entry(3205,3207),
    Map.entry(3207,9193),
    Map.entry(3213,582),
    Map.entry(323,325),
    Map.entry(325,10109),
    Map.entry(326,327),
    Map.entry(327,3652),
    Map.entry(3299,2468),
    Map.entry(3304,3305),
    Map.entry(3305,5836),
    Map.entry(3383,6221),
    Map.entry(3423,3424),
    Map.entry(3424,6985),
    Map.entry(3432,3434),
    Map.entry(3434,323),
    Map.entry(3471,1936),
    Map.entry(351,353),
    Map.entry(3515,2615),
    Map.entry(353,773),
    Map.entry(355,356),
    Map.entry(3559,7418),
    Map.entry(356,11366),
    Map.entry(3597,3598),
    Map.entry(3598,8635),
    Map.entry(3628,3629),
    Map.entry(3629,3107),
    Map.entry(363,364),
    Map.entry(364,6983),
    Map.entry(3652,9572),
    Map.entry(3670,8411),
    Map.entry(3814,3816),
    Map.entry(3816,7084),
    Map.entry(3858,6061),
    Map.entry(3875,3876),
    Map.entry(3876,2458),
    Map.entry(398,399),
    Map.entry(399,3471),
    Map.entry(4057,2277),
    Map.entry(4149,2316),
    Map.entry(4163,6214),
    Map.entry(4201,4203),
    Map.entry(4203,5670),
    Map.entry(4213,6243),
    Map.entry(4284,5690),
    Map.entry(4286,6625),
    Map.entry(4298,9435),
    Map.entry(4347,4348),
    Map.entry(4348,6066),
    Map.entry(4357,4358),
    Map.entry(4358,6855),
    Map.entry(4414,8229),
    Map.entry(4516,4620),
    Map.entry(4529,1155),
    Map.entry(4535,5625),
    Map.entry(4543,8810),
    Map.entry(4620,3597),
    Map.entry(4641,4881),
    Map.entry(4693,4694),
    Map.entry(4694,5408),
    Map.entry(4742,4743),
    Map.entry(4743,3024),
    Map.entry(4767,4768),
    Map.entry(4768,5748),
    Map.entry(4774,4775),
    Map.entry(4775,5797),
    Map.entry(4881,7348),
    Map.entry(4882,4883),
    Map.entry(4883,4357),
    Map.entry(4927,11930),
    Map.entry(4932,5186),
    Map.entry(5017,7725),
    Map.entry(5024,5861),
    Map.entry(5145,5146),
    Map.entry(5146,525),
    Map.entry(5183,5184),
    Map.entry(5184,218),
    Map.entry(5186,4543),
    Map.entry(525,526),
    Map.entry(526,2118),
    Map.entry(5408,351),
    Map.entry(5481,9498),
    Map.entry(5625,4414),
    Map.entry(5670,11197),
    Map.entry(5690,5691),
    Map.entry(5691,10690),
    Map.entry(5797,4149),
    Map.entry(582,583),
    Map.entry(583,8426),
    Map.entry(5830,355),
    Map.entry(5836,11066),
    Map.entry(5861,5862),
    Map.entry(5862,1950),
    Map.entry(6,8),
    Map.entry(605,606),
    Map.entry(606,4529),
    Map.entry(6061,3628),
    Map.entry(6066,10506),
    Map.entry(6076,1162),
    Map.entry(6130,6131),
    Map.entry(6131,8353),
    Map.entry(6168,7647),
    Map.entry(621,11024),
    Map.entry(6214,3423),
    Map.entry(6221,6222),
    Map.entry(6222,7324),
    Map.entry(6234,2393),
    Map.entry(6243,4774),
    Map.entry(632,6750),
    Map.entry(6625,5024),
    Map.entry(6708,8140),
    Map.entry(6750,6752),
    Map.entry(6752,8339),
    Map.entry(6805,3299),
    Map.entry(6855,6856),
    Map.entry(6856,1041),
    Map.entry(6889,4932),
    Map.entry(6944,11438),
    Map.entry(6973,11439),
    Map.entry(6983,6984),
    Map.entry(6984,8154),
    Map.entry(6985,927),
    Map.entry(6989,3011),
    Map.entry(7019,4742),
    Map.entry(7023,5183),
    Map.entry(7084,10983),
    Map.entry(7086,888),
    Map.entry(7106,7645),
    Map.entry(7217,10298),
    Map.entry(7254,2928),
    Map.entry(7294,7295),
    Map.entry(7295,7524),
    Map.entry(7324,3205),
    Map.entry(7328,7330),
    Map.entry(7330,2750),
    //Map.entry(7339,130),
    Map.entry(7339,7328),
    Map.entry(7340,8109),
    Map.entry(7348,10565),
    Map.entry(7349,3559),
    Map.entry(7418,11172),
    Map.entry(7477,10378),
    Map.entry(7512,7513),
    Map.entry(7513,7254),
    Map.entry(7524,605),
    Map.entry(7558,1832),
    Map.entry(7611,9865),
    Map.entry(7645,7646),
    Map.entry(7646,3213),
    Map.entry(7647,4201),
    Map.entry(7725,7775),
    Map.entry(773,2252),
    Map.entry(7775,9024),
    Map.entry(7781,130),
    Map.entry(7853,7855),
    Map.entry(7855,398),
    Map.entry(8,4535),
    Map.entry(8059,10517),
    Map.entry(8109,2919),
    Map.entry(8140,10966),
    Map.entry(8154,6076),
    Map.entry(8201,8202),
    Map.entry(8202,2680),
    Map.entry(8229,8918),
    Map.entry(8293,2413),
    Map.entry(8335,180),
    Map.entry(8339,2323),
    Map.entry(8353,8354),
    Map.entry(8354,7853),
    Map.entry(8411,6234),
    Map.entry(8426,1821),
    Map.entry(843,845),
    Map.entry(8444,363),
    Map.entry(845,3670),
    Map.entry(8475,5017),
    Map.entry(8494,8495),
    Map.entry(8495,6130),
    Map.entry(8502,2146),
    Map.entry(8635,1290),
    Map.entry(8683,8684),
    Map.entry(8684,10572),
    Map.entry(8810,8812),
    Map.entry(8812,9103),
    Map.entry(887,6708),
    Map.entry(888,889),
    Map.entry(889,226),
    Map.entry(8918,7611),
    Map.entry(8923,6889),
    Map.entry(9024,8059),
    Map.entry(9103,4516),
    Map.entry(9159,5481),
    Map.entry(9193,10071),
    Map.entry(927,929),
    Map.entry(929,8475),
    Map.entry(9347,9348),
    Map.entry(9348,8335),
    Map.entry(9435,3432),
    Map.entry(9498,7217),
    Map.entry(9521,621),
    Map.entry(9569,4927),
    Map.entry(9572,9573),
    Map.entry(9573,9908),
    Map.entry(9841,9521),
    Map.entry(9865,9866),
    Map.entry(9866,1732),
    Map.entry(9908,8201)
  );
  // New Year's Eve in Manhattan: speed on Broadway is at 80% at 11:30 PM, then
  // speed decreases starting from midnight until 1:30 AM to 20% until 5:00 AM.
  // We do (vertex - 1) because edges above are 0-indexed while nodes in Jargo
  // are 1-indexed.
  public double apply(int v1, int v2, long msec) \{
    double per = 1.0;
    if ((lu_broadway.containsKey(v1-1) && lu_broadway.get(v1-1) == v2-1)
     || (lu_broadway.containsKey(v2-1) && lu_broadway.get(v2-1) == v1-1)) \{
      if (msec > 84600_000) \{  // 20% at 11:30 PM
        // per = 1-0.8*(86400_000 - msec)/1800_000;
        per = 0.2;
      \} else if (msec < 5400_000) \{  // 100% at 12:00AM moving to 20% at 1:30 AM
        per = Math.max(0.2, (5400_000 - msec)/5400_000);
      \} else if (msec < 18000_000) \{  // 20% from 1:30 AM to 5:00 AM
        per = 0.2;
      \}
    \}
    return per;
  \}
\}
\nwnotused{Broadway.java}\nwendcode{}\nwbegindocs{2}\nwdocspar

\nwenddocs{}\nwfilename{src/utilities.nw}\nwbegindocs{0}\part{Utilities}
\label{part-utilities}

\nwenddocs{}\nwbegincode{1}\sublabel{NW2LUTbN-1rvh0k-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW2LUTbN-1rvh0k-1}}}\moddef{Utilities: route cache~{\nwtagstyle{}\subpageref{NW2LUTbN-1rvh0k-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW2W5UTV-qLZ3e-1}}\nwenddeflinemarkup
final Map<Integer, int[]> cache_routes = new HashMap<Integer, int[]>();
\nwused{\\{NW2W5UTV-qLZ3e-1}}\nwendcode{}\nwbegindocs{2}\nwdocspar

\nwenddocs{}\nwbegincode{3}\sublabel{NW2LUTbN-wIy2f-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW2LUTbN-wIy2f-1}}}\moddef{Utilities: put route cache~{\nwtagstyle{}\subpageref{NW2LUTbN-wIy2f-1}}}\endmoddef\nwstartdeflinemarkup\nwenddeflinemarkup
cache_routes.put(sid, wnew);
\nwnotused{Utilities: put route cache}\nwendcode{}\nwbegindocs{4}\nwdocspar

\nwenddocs{}\nwbegincode{5}\sublabel{NW2LUTbN-1fC59W-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW2LUTbN-1fC59W-1}}}\moddef{Utilities: get route cache~{\nwtagstyle{}\subpageref{NW2LUTbN-1fC59W-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NWEBrBs-4C3qWe-1}}\nwenddeflinemarkup
if (cache_routes.containsKey(sid)) \{
  route = cache_routes.get(sid);
\} else \{
  route = this.communicator.queryServerRouteRemaining(sid,
    this.communicator.retrieveClock());
  cache_routes.put(sid, route);
\}
\nwused{\\{NWEBrBs-4C3qWe-1}}\nwendcode{}\nwbegindocs{6}\nwdocspar

\nwenddocs{}\nwfilename{src/debug.nw}\nwbegindocs{0}\part{Debug}
\label{part-debug}

\nwenddocs{}\nwbegincode{1}\sublabel{NW3ZDnOU-HVWtO-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW3ZDnOU-HVWtO-1}}}\moddef{Debug: print request~{\nwtagstyle{}\subpageref{NW3ZDnOU-HVWtO-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwenddeflinemarkup
if (DEBUG) \{
  System.out.printf("got request=\{ %d, %d, %d, %d, %d, %d, %d \}\\n",
      r[0], r[1], r[2], r[3], r[4], r[5], r[6]);
\}
\nwused{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwendcode{}\nwbegindocs{2}\nwdocspar

\nwenddocs{}\nwbegincode{3}\sublabel{NW3ZDnOU-3B7sph-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW3ZDnOU-3B7sph-1}}}\moddef{Debug: print candidates~{\nwtagstyle{}\subpageref{NW3ZDnOU-3B7sph-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwenddeflinemarkup
if (DEBUG) \{
  System.out.printf("got candidates=\{ #%d \}\\n", candidates.size());
\}
\nwused{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwendcode{}\nwbegindocs{4}\nwdocspar

\nwenddocs{}\nwbegincode{5}\sublabel{NW3ZDnOU-2L4VdO-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW3ZDnOU-2L4VdO-1}}}\moddef{Debug: map/filter: last update time~{\nwtagstyle{}\subpageref{NW3ZDnOU-2L4VdO-1}}}\endmoddef\nwstartdeflinemarkup\nwenddeflinemarkup
if (DEBUG) \{
  System.out.printf("do map/filter: last update time\\n");
\}
\nwnotused{Debug: map/filter: last update time}\nwendcode{}\nwbegindocs{6}\nwdocspar

\nwenddocs{}\nwbegincode{7}\sublabel{NW3ZDnOU-1KKA0d-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW3ZDnOU-1KKA0d-1}}}\moddef{Debug: map/filter: proximity~{\nwtagstyle{}\subpageref{NW3ZDnOU-1KKA0d-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwenddeflinemarkup
if (DEBUG) \{
  System.out.printf("do map/filter: proximity\\n");
\}
\nwused{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwendcode{}\nwbegindocs{8}\nwdocspar

\nwenddocs{}\nwbegincode{9}\sublabel{NW3ZDnOU-2WwrvE-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW3ZDnOU-2WwrvE-1}}}\moddef{Debug: map/filter: schedule length~{\nwtagstyle{}\subpageref{NW3ZDnOU-2WwrvE-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW2W5UTV-4ZdLuY-1}}\nwenddeflinemarkup
if (DEBUG) \{
  System.out.printf("do map/filter: schedule length\\n");
\}
\nwused{\\{NW2W5UTV-4ZdLuY-1}}\nwendcode{}\nwbegindocs{10}\nwdocspar

\nwenddocs{}\nwbegincode{11}\sublabel{NW3ZDnOU-1e6AJj-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW3ZDnOU-1e6AJj-1}}}\moddef{Debug: map/filter: perpendicular~{\nwtagstyle{}\subpageref{NW3ZDnOU-1e6AJj-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW2W5UTV-wXujK-1}}\nwenddeflinemarkup
if (DEBUG) \{
  System.out.printf("do map/filter: perpendicular\\n");
\}
\nwused{\\{NW2W5UTV-wXujK-1}}\nwendcode{}\nwbegindocs{12}\nwdocspar

\nwenddocs{}\nwbegincode{13}\sublabel{NW3ZDnOU-MmR2q-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW3ZDnOU-MmR2q-1}}}\moddef{Debug: print candidate~{\nwtagstyle{}\subpageref{NW3ZDnOU-MmR2q-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwenddeflinemarkup
if (DEBUG) \{
  System.out.printf("got cand=\{ %d, %d \}\\n", cand.getKey(), cand.getValue());
\}
\nwused{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwendcode{}\nwbegindocs{14}\nwdocspar

\nwenddocs{}\nwbegincode{15}\sublabel{NW3ZDnOU-JSCdp-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW3ZDnOU-JSCdp-1}}}\moddef{Debug: print brem~{\nwtagstyle{}\subpageref{NW3ZDnOU-JSCdp-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwenddeflinemarkup
if (DEBUG) \{
  System.out.printf("got brem=\\n");
  for (int __i = 0; __i < (brem.length - 3); __i += 4) \{
    System.out.printf("  \{ %d, %d, %d, %d \}\\n",
        brem[__i], brem[__i+1], brem[__i+2], brem[__i+3]);
  \}
\}
\nwused{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwendcode{}\nwbegindocs{16}\nwdocspar

\nwenddocs{}\nwbegincode{17}\sublabel{NW3ZDnOU-2EstFd-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW3ZDnOU-2EstFd-1}}}\moddef{Debug: print bnew~{\nwtagstyle{}\subpageref{NW3ZDnOU-2EstFd-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwenddeflinemarkup
if (DEBUG) \{
  System.out.printf("got bnew=\\n");
  for (int __i = 0; __i < (bnew.length - 3); __i += 4) \{
    System.out.printf("  \{ %d, %d, %d, %d \}\\n",
        bnew[__i], bnew[__i+1], bnew[__i+2], bnew[__i+3]);
  \}
\}
\nwused{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwendcode{}\nwbegindocs{18}\nwdocspar

\nwenddocs{}\nwbegincode{19}\sublabel{NW3ZDnOU-3b2tUV-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW3ZDnOU-3b2tUV-1}}}\moddef{Debug: print stop~{\nwtagstyle{}\subpageref{NW3ZDnOU-3b2tUV-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwenddeflinemarkup
if (DEBUG) \{
  System.out.printf("set stop=\{ %d, %d, %d, %d \}\\n",
      stop[0], stop[1], stop[2], stop[3]);
\}
\nwused{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwendcode{}\nwbegindocs{20}\nwdocspar

\nwenddocs{}\nwbegincode{21}\sublabel{NW3ZDnOU-1BeOIe-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW3ZDnOU-1BeOIe-1}}}\moddef{Debug: print ipos~{\nwtagstyle{}\subpageref{NW3ZDnOU-1BeOIe-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwenddeflinemarkup
if (DEBUG) \{
  System.out.printf("set ipos=%d\\n", ipos);
\}
\nwused{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwendcode{}\nwbegindocs{22}\nwdocspar

\nwenddocs{}\nwbegincode{23}\sublabel{NW3ZDnOU-1VOGcH-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW3ZDnOU-1VOGcH-1}}}\moddef{Debug: print tbeg, tend~{\nwtagstyle{}\subpageref{NW3ZDnOU-1VOGcH-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwenddeflinemarkup
if (DEBUG) \{
  System.out.printf("set tbeg=%d, tend=%d\\n", tbeg, tend);
\}
\nwused{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwendcode{}\nwbegindocs{24}\nwdocspar

\nwenddocs{}\nwbegincode{25}\sublabel{NW3ZDnOU-4aj6aA-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW3ZDnOU-4aj6aA-1}}}\moddef{Debug: print wact~{\nwtagstyle{}\subpageref{NW3ZDnOU-4aj6aA-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwenddeflinemarkup
if (DEBUG) \{
  System.out.printf("got wact=\\n");
  for (int __i = 0; __i < (wact.length - 1); __i += 2) \{
    System.out.printf("  \{ %d, %d \}\\n",
        wact[__i], wact[(__i + 1)]);
  \}
\}
\nwused{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwendcode{}\nwbegindocs{26}\nwdocspar

\nwenddocs{}\nwbegincode{27}\sublabel{NW3ZDnOU-4ZeXS0-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW3ZDnOU-4ZeXS0-1}}}\moddef{Debug: echo limitation 4~{\nwtagstyle{}\subpageref{NW3ZDnOU-4ZeXS0-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwenddeflinemarkup
if (DEBUG) \{
  System.out.printf("detected limitation #4\\n");
\}
\nwused{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwendcode{}\nwbegindocs{28}\nwdocspar

\nwenddocs{}\nwbegincode{29}\sublabel{NW3ZDnOU-34iFF1-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW3ZDnOU-34iFF1-1}}}\moddef{Debug: echo remove event~{\nwtagstyle{}\subpageref{NW3ZDnOU-34iFF1-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwenddeflinemarkup
if (DEBUG) \{
  System.out.printf("remove event\\n");
\}
\nwused{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwendcode{}\nwbegindocs{30}\nwdocspar

\nwenddocs{}\nwbegincode{31}\sublabel{NW3ZDnOU-2Coo86-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW3ZDnOU-2Coo86-1}}}\moddef{Debug: echo check capacity~{\nwtagstyle{}\subpageref{NW3ZDnOU-2Coo86-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwenddeflinemarkup
if (DEBUG) \{
  System.out.printf("check capacity\\n");
\}
\nwused{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwendcode{}\nwbegindocs{32}\nwdocspar

\nwenddocs{}\nwbegincode{33}\sublabel{NW3ZDnOU-IruGu-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW3ZDnOU-IruGu-1}}}\moddef{Debug: echo check time window~{\nwtagstyle{}\subpageref{NW3ZDnOU-IruGu-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwenddeflinemarkup
if (DEBUG) \{
  System.out.printf("check time window\\n");
\}
\nwused{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwendcode{}\nwbegindocs{34}\nwdocspar

\nwenddocs{}\nwbegincode{35}\sublabel{NW3ZDnOU-2Hm6y-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW3ZDnOU-2Hm6y-1}}}\moddef{Debug: print ok~{\nwtagstyle{}\subpageref{NW3ZDnOU-2Hm6y-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwenddeflinemarkup
if (DEBUG) \{
  System.out.printf("set ok=%s\\n", (ok ? "true" : "false"));
\}
\nwused{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwendcode{}\nwbegindocs{36}\nwdocspar

\nwenddocs{}\nwbegincode{37}\sublabel{NW3ZDnOU-2EsvK6-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW3ZDnOU-2EsvK6-1}}}\moddef{Debug: print wbeg~{\nwtagstyle{}\subpageref{NW3ZDnOU-2EsvK6-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwenddeflinemarkup
if (DEBUG) \{
  System.out.printf("set wbeg=\{ %d, %d \}\\n", wbeg[0], wbeg[1]);
\}
\nwused{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwendcode{}\nwbegindocs{38}\nwdocspar

\nwenddocs{}\nwbegincode{39}\sublabel{NW3ZDnOU-28quig-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW3ZDnOU-28quig-1}}}\moddef{Debug: print wnew~{\nwtagstyle{}\subpageref{NW3ZDnOU-28quig-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwenddeflinemarkup
if (DEBUG) \{
  System.out.printf("set wnew=\\n");
  for (int __i = 0; __i < (wnew.length - 1); __i += 2) \{
    System.out.printf("  \{ %d, %d \}\\n",
        wnew[__i], wnew[(__i + 1)]);
  \}
\}
\nwused{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwendcode{}\nwbegindocs{40}\nwdocspar

\nwenddocs{}\nwbegincode{41}\sublabel{NW3ZDnOU-1BQUqJ-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW3ZDnOU-1BQUqJ-1}}}\moddef{Debug: print remove candidate~{\nwtagstyle{}\subpageref{NW3ZDnOU-1BQUqJ-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwenddeflinemarkup
if (DEBUG) \{
  System.out.printf("remove candidate %d\\n", sid);
\}
\nwused{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwendcode{}\nwbegindocs{42}\nwdocspar

\nwenddocs{}\nwbegincode{43}\sublabel{NW3ZDnOU-40f0Up-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW3ZDnOU-40f0Up-1}}}\moddef{Debug: print imax, jmax, cost~{\nwtagstyle{}\subpageref{NW3ZDnOU-40f0Up-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwenddeflinemarkup
if (DEBUG) \{
  System.out.printf("set imax=%d, jmax=%d, cost=%d\\n", imax, jmax, cost);
\}
\nwused{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwendcode{}\nwbegindocs{44}\nwdocspar

\nwenddocs{}\nwbegincode{45}\sublabel{NW3ZDnOU-30mX6u-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW3ZDnOU-30mX6u-1}}}\moddef{Debug: print i, j~{\nwtagstyle{}\subpageref{NW3ZDnOU-30mX6u-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwenddeflinemarkup
if (DEBUG) \{
  System.out.printf("set i=%d, j=%d\\n", i, j);
\}
\nwused{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwendcode{}\nwbegindocs{46}\nwdocspar

\nwenddocs{}\nwbegincode{47}\sublabel{NW3ZDnOU-2ty1Mu-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW3ZDnOU-2ty1Mu-1}}}\moddef{Debug: print cmin~{\nwtagstyle{}\subpageref{NW3ZDnOU-2ty1Mu-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwenddeflinemarkup
if (DEBUG) \{
  System.out.printf("set cmin=%d\\n", cmin);
\}
\nwused{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwendcode{}\nwbegindocs{48}\nwdocspar

\nwenddocs{}\nwbegincode{49}\sublabel{NW3ZDnOU-8YBCE-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW3ZDnOU-8YBCE-1}}}\moddef{Debug: print queue size~{\nwtagstyle{}\subpageref{NW3ZDnOU-8YBCE-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW2W5UTV-4ZdLuY-1}}\nwenddeflinemarkup
if (DEBUG) \{
  System.out.printf("got queue size=%d\\n", this.queue.size());
\}
\nwused{\\{NW2W5UTV-4ZdLuY-1}}\nwendcode{}\nwbegindocs{50}\nwdocspar

\nwenddocs{}\nwbegincode{51}\sublabel{NW3ZDnOU-1piQ1l-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW3ZDnOU-1piQ1l-1}}}\moddef{Debug: echo start insertion heuristic~{\nwtagstyle{}\subpageref{NW3ZDnOU-1piQ1l-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwenddeflinemarkup
if (DEBUG) \{
  System.out.printf("start insertion heuristic\\n");
\}
\nwused{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwendcode{}\nwbegindocs{52}\nwdocspar

\nwenddocs{}\nwbegincode{53}\sublabel{NW3ZDnOU-kwxOS-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW3ZDnOU-kwxOS-1}}}\moddef{Debug: echo end insertion heuristic~{\nwtagstyle{}\subpageref{NW3ZDnOU-kwxOS-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwenddeflinemarkup
if (DEBUG) \{
  System.out.printf("end insertion heuristic\\n");
\}
\nwused{\\{NW2W5UTV-16KpI3-1}\\{NW2W5UTV-2OWvsM-1}\\{NW2W5UTV-4ZdLuY-1}\\{NW2W5UTV-wXujK-1}}\nwendcode{}\nwbegindocs{54}\nwdocspar

\nwenddocs{}\nwbegincode{55}\sublabel{NW3ZDnOU-1Lylbo-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW3ZDnOU-1Lylbo-1}}}\moddef{Debug: echo empty candidates~{\nwtagstyle{}\subpageref{NW3ZDnOU-1Lylbo-1}}}\endmoddef\nwstartdeflinemarkup\nwenddeflinemarkup
if (DEBUG) \{
  System.out.printf("empty candidates\\n");
\}
\nwnotused{Debug: echo empty candidates}\nwendcode{}\nwbegindocs{56}\nwdocspar

\nwenddocs{}\nwbegincode{57}\sublabel{NW3ZDnOU-3IJWHX-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW3ZDnOU-3IJWHX-1}}}\moddef{Debug: echo fallback~{\nwtagstyle{}\subpageref{NW3ZDnOU-3IJWHX-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW2W5UTV-4ZdLuY-1}}\nwenddeflinemarkup
if (DEBUG) \{
  System.out.printf("fallback\\n");
\}
\nwused{\\{NW2W5UTV-4ZdLuY-1}}\nwendcode{}

\nwixlogsorted{c}{{Broadway.java}{NW1QgbvE-3asg0V-1}{\nwixd{NW1QgbvE-3asg0V-1}}}%
\nwixlogsorted{c}{{Debug: echo check capacity}{NW3ZDnOU-2Coo86-1}{\nwixu{NW2W5UTV-16KpI3-1}\nwixu{NW2W5UTV-2OWvsM-1}\nwixu{NW2W5UTV-4ZdLuY-1}\nwixu{NW2W5UTV-wXujK-1}\nwixd{NW3ZDnOU-2Coo86-1}}}%
\nwixlogsorted{c}{{Debug: echo check time window}{NW3ZDnOU-IruGu-1}{\nwixu{NW2W5UTV-16KpI3-1}\nwixu{NW2W5UTV-2OWvsM-1}\nwixu{NW2W5UTV-4ZdLuY-1}\nwixu{NW2W5UTV-wXujK-1}\nwixd{NW3ZDnOU-IruGu-1}}}%
\nwixlogsorted{c}{{Debug: echo empty candidates}{NW3ZDnOU-1Lylbo-1}{\nwixd{NW3ZDnOU-1Lylbo-1}}}%
\nwixlogsorted{c}{{Debug: echo end insertion heuristic}{NW3ZDnOU-kwxOS-1}{\nwixu{NW2W5UTV-16KpI3-1}\nwixu{NW2W5UTV-2OWvsM-1}\nwixu{NW2W5UTV-4ZdLuY-1}\nwixu{NW2W5UTV-wXujK-1}\nwixd{NW3ZDnOU-kwxOS-1}}}%
\nwixlogsorted{c}{{Debug: echo fallback}{NW3ZDnOU-3IJWHX-1}{\nwixu{NW2W5UTV-4ZdLuY-1}\nwixd{NW3ZDnOU-3IJWHX-1}}}%
\nwixlogsorted{c}{{Debug: echo limitation 4}{NW3ZDnOU-4ZeXS0-1}{\nwixu{NW2W5UTV-16KpI3-1}\nwixu{NW2W5UTV-2OWvsM-1}\nwixu{NW2W5UTV-4ZdLuY-1}\nwixu{NW2W5UTV-wXujK-1}\nwixd{NW3ZDnOU-4ZeXS0-1}}}%
\nwixlogsorted{c}{{Debug: echo remove event}{NW3ZDnOU-34iFF1-1}{\nwixu{NW2W5UTV-16KpI3-1}\nwixu{NW2W5UTV-2OWvsM-1}\nwixu{NW2W5UTV-4ZdLuY-1}\nwixu{NW2W5UTV-wXujK-1}\nwixd{NW3ZDnOU-34iFF1-1}}}%
\nwixlogsorted{c}{{Debug: echo start insertion heuristic}{NW3ZDnOU-1piQ1l-1}{\nwixu{NW2W5UTV-16KpI3-1}\nwixu{NW2W5UTV-2OWvsM-1}\nwixu{NW2W5UTV-4ZdLuY-1}\nwixu{NW2W5UTV-wXujK-1}\nwixd{NW3ZDnOU-1piQ1l-1}}}%
\nwixlogsorted{c}{{Debug: map/filter: last update time}{NW3ZDnOU-2L4VdO-1}{\nwixd{NW3ZDnOU-2L4VdO-1}}}%
\nwixlogsorted{c}{{Debug: map/filter: perpendicular}{NW3ZDnOU-1e6AJj-1}{\nwixu{NW2W5UTV-wXujK-1}\nwixd{NW3ZDnOU-1e6AJj-1}}}%
\nwixlogsorted{c}{{Debug: map/filter: proximity}{NW3ZDnOU-1KKA0d-1}{\nwixu{NW2W5UTV-16KpI3-1}\nwixu{NW2W5UTV-2OWvsM-1}\nwixu{NW2W5UTV-4ZdLuY-1}\nwixu{NW2W5UTV-wXujK-1}\nwixd{NW3ZDnOU-1KKA0d-1}}}%
\nwixlogsorted{c}{{Debug: map/filter: schedule length}{NW3ZDnOU-2WwrvE-1}{\nwixu{NW2W5UTV-4ZdLuY-1}\nwixd{NW3ZDnOU-2WwrvE-1}}}%
\nwixlogsorted{c}{{Debug: print bnew}{NW3ZDnOU-2EstFd-1}{\nwixu{NW2W5UTV-16KpI3-1}\nwixu{NW2W5UTV-2OWvsM-1}\nwixu{NW2W5UTV-4ZdLuY-1}\nwixu{NW2W5UTV-wXujK-1}\nwixd{NW3ZDnOU-2EstFd-1}}}%
\nwixlogsorted{c}{{Debug: print brem}{NW3ZDnOU-JSCdp-1}{\nwixu{NW2W5UTV-16KpI3-1}\nwixu{NW2W5UTV-2OWvsM-1}\nwixu{NW2W5UTV-4ZdLuY-1}\nwixu{NW2W5UTV-wXujK-1}\nwixd{NW3ZDnOU-JSCdp-1}}}%
\nwixlogsorted{c}{{Debug: print candidate}{NW3ZDnOU-MmR2q-1}{\nwixu{NW2W5UTV-16KpI3-1}\nwixu{NW2W5UTV-2OWvsM-1}\nwixu{NW2W5UTV-4ZdLuY-1}\nwixu{NW2W5UTV-wXujK-1}\nwixd{NW3ZDnOU-MmR2q-1}}}%
\nwixlogsorted{c}{{Debug: print candidates}{NW3ZDnOU-3B7sph-1}{\nwixu{NW2W5UTV-16KpI3-1}\nwixu{NW2W5UTV-2OWvsM-1}\nwixu{NW2W5UTV-4ZdLuY-1}\nwixu{NW2W5UTV-wXujK-1}\nwixd{NW3ZDnOU-3B7sph-1}}}%
\nwixlogsorted{c}{{Debug: print cmin}{NW3ZDnOU-2ty1Mu-1}{\nwixu{NW2W5UTV-16KpI3-1}\nwixu{NW2W5UTV-2OWvsM-1}\nwixu{NW2W5UTV-4ZdLuY-1}\nwixu{NW2W5UTV-wXujK-1}\nwixd{NW3ZDnOU-2ty1Mu-1}}}%
\nwixlogsorted{c}{{Debug: print i, j}{NW3ZDnOU-30mX6u-1}{\nwixu{NW2W5UTV-16KpI3-1}\nwixu{NW2W5UTV-2OWvsM-1}\nwixu{NW2W5UTV-4ZdLuY-1}\nwixu{NW2W5UTV-wXujK-1}\nwixd{NW3ZDnOU-30mX6u-1}}}%
\nwixlogsorted{c}{{Debug: print imax, jmax, cost}{NW3ZDnOU-40f0Up-1}{\nwixu{NW2W5UTV-16KpI3-1}\nwixu{NW2W5UTV-2OWvsM-1}\nwixu{NW2W5UTV-4ZdLuY-1}\nwixu{NW2W5UTV-wXujK-1}\nwixd{NW3ZDnOU-40f0Up-1}}}%
\nwixlogsorted{c}{{Debug: print ipos}{NW3ZDnOU-1BeOIe-1}{\nwixu{NW2W5UTV-16KpI3-1}\nwixu{NW2W5UTV-2OWvsM-1}\nwixu{NW2W5UTV-4ZdLuY-1}\nwixu{NW2W5UTV-wXujK-1}\nwixd{NW3ZDnOU-1BeOIe-1}}}%
\nwixlogsorted{c}{{Debug: print ok}{NW3ZDnOU-2Hm6y-1}{\nwixu{NW2W5UTV-16KpI3-1}\nwixu{NW2W5UTV-2OWvsM-1}\nwixu{NW2W5UTV-4ZdLuY-1}\nwixu{NW2W5UTV-wXujK-1}\nwixd{NW3ZDnOU-2Hm6y-1}}}%
\nwixlogsorted{c}{{Debug: print queue size}{NW3ZDnOU-8YBCE-1}{\nwixu{NW2W5UTV-4ZdLuY-1}\nwixd{NW3ZDnOU-8YBCE-1}}}%
\nwixlogsorted{c}{{Debug: print remove candidate}{NW3ZDnOU-1BQUqJ-1}{\nwixu{NW2W5UTV-16KpI3-1}\nwixu{NW2W5UTV-2OWvsM-1}\nwixu{NW2W5UTV-4ZdLuY-1}\nwixu{NW2W5UTV-wXujK-1}\nwixd{NW3ZDnOU-1BQUqJ-1}}}%
\nwixlogsorted{c}{{Debug: print request}{NW3ZDnOU-HVWtO-1}{\nwixu{NW2W5UTV-16KpI3-1}\nwixu{NW2W5UTV-2OWvsM-1}\nwixu{NW2W5UTV-4ZdLuY-1}\nwixu{NW2W5UTV-wXujK-1}\nwixd{NW3ZDnOU-HVWtO-1}}}%
\nwixlogsorted{c}{{Debug: print stop}{NW3ZDnOU-3b2tUV-1}{\nwixu{NW2W5UTV-16KpI3-1}\nwixu{NW2W5UTV-2OWvsM-1}\nwixu{NW2W5UTV-4ZdLuY-1}\nwixu{NW2W5UTV-wXujK-1}\nwixd{NW3ZDnOU-3b2tUV-1}}}%
\nwixlogsorted{c}{{Debug: print tbeg, tend}{NW3ZDnOU-1VOGcH-1}{\nwixu{NW2W5UTV-16KpI3-1}\nwixu{NW2W5UTV-2OWvsM-1}\nwixu{NW2W5UTV-4ZdLuY-1}\nwixu{NW2W5UTV-wXujK-1}\nwixd{NW3ZDnOU-1VOGcH-1}}}%
\nwixlogsorted{c}{{Debug: print wact}{NW3ZDnOU-4aj6aA-1}{\nwixu{NW2W5UTV-16KpI3-1}\nwixu{NW2W5UTV-2OWvsM-1}\nwixu{NW2W5UTV-4ZdLuY-1}\nwixu{NW2W5UTV-wXujK-1}\nwixd{NW3ZDnOU-4aj6aA-1}}}%
\nwixlogsorted{c}{{Debug: print wbeg}{NW3ZDnOU-2EsvK6-1}{\nwixu{NW2W5UTV-16KpI3-1}\nwixu{NW2W5UTV-2OWvsM-1}\nwixu{NW2W5UTV-4ZdLuY-1}\nwixu{NW2W5UTV-wXujK-1}\nwixd{NW3ZDnOU-2EsvK6-1}}}%
\nwixlogsorted{c}{{Debug: print wnew}{NW3ZDnOU-28quig-1}{\nwixu{NW2W5UTV-16KpI3-1}\nwixu{NW2W5UTV-2OWvsM-1}\nwixu{NW2W5UTV-4ZdLuY-1}\nwixu{NW2W5UTV-wXujK-1}\nwixd{NW3ZDnOU-28quig-1}}}%
\nwixlogsorted{c}{{GreedyInsertion.java}{NW2W5UTV-1Tuf6f-1}{\nwixd{NW2W5UTV-1Tuf6f-1}}}%
\nwixlogsorted{c}{{GreedyInsertion: handleRequest(1)}{NW2W5UTV-2OWvsM-1}{\nwixu{NW2W5UTV-1Tuf6f-1}\nwixd{NW2W5UTV-2OWvsM-1}}}%
\nwixlogsorted{c}{{GreedyInsertion: preamble}{NW2W5UTV-2erqlI-1}{\nwixu{NW2W5UTV-1Tuf6f-1}\nwixd{NW2W5UTV-2erqlI-1}\nwixu{NW2W5UTV-2phINB-1}}}%
\nwixlogsorted{c}{{GreedyInsertionFallback.java}{NW2W5UTV-2phINB-1}{\nwixd{NW2W5UTV-2phINB-1}}}%
\nwixlogsorted{c}{{GreedyInsertionFallback: handleRequest(1)}{NW2W5UTV-4ZdLuY-1}{\nwixu{NW2W5UTV-2phINB-1}\nwixd{NW2W5UTV-4ZdLuY-1}}}%
\nwixlogsorted{c}{{Map/Filter: Perpendicular}{NWEBrBs-4C3qWe-1}{\nwixd{NWEBrBs-4C3qWe-1}\nwixu{NW2W5UTV-wXujK-1}}}%
\nwixlogsorted{c}{{Map/Filter: Proximity}{NWEBrBs-4AhmPL-1}{\nwixd{NWEBrBs-4AhmPL-1}\nwixu{NW2W5UTV-16KpI3-1}\nwixu{NW2W5UTV-2OWvsM-1}\nwixu{NW2W5UTV-4ZdLuY-1}\nwixu{NW2W5UTV-wXujK-1}}}%
\nwixlogsorted{c}{{Map/Filter: Schedule Length}{NWEBrBs-3tu5Lh-1}{\nwixd{NWEBrBs-3tu5Lh-1}\nwixu{NW2W5UTV-4ZdLuY-1}}}%
\nwixlogsorted{c}{{NearestNeighbor.java}{NW2W5UTV-QNBZk-1}{\nwixd{NW2W5UTV-QNBZk-1}}}%
\nwixlogsorted{c}{{NearestNeighbor: handleRequest(1)}{NW2W5UTV-16KpI3-1}{\nwixu{NW2W5UTV-QNBZk-1}\nwixd{NW2W5UTV-16KpI3-1}}}%
\nwixlogsorted{c}{{NearestNeighbor: preamble}{NW2W5UTV-18lzwh-1}{\nwixu{NW2W5UTV-QNBZk-1}\nwixd{NW2W5UTV-18lzwh-1}}}%
\nwixlogsorted{c}{{NearestPerpendicular.java}{NW2W5UTV-qLZ3e-1}{\nwixd{NW2W5UTV-qLZ3e-1}}}%
\nwixlogsorted{c}{{NearestPerpendicular: handleRequest(1)}{NW2W5UTV-wXujK-1}{\nwixu{NW2W5UTV-qLZ3e-1}\nwixd{NW2W5UTV-wXujK-1}}}%
\nwixlogsorted{c}{{NearestPerpendicular: preamble}{NW2W5UTV-3pPKWW-1}{\nwixu{NW2W5UTV-qLZ3e-1}\nwixd{NW2W5UTV-3pPKWW-1}}}%
\nwixlogsorted{c}{{Reduce: Maximum Value}{NW2D7mP3-2K8kfr-1}{\nwixd{NW2D7mP3-2K8kfr-1}}}%
\nwixlogsorted{c}{{Reduce: Minimum Value}{NW2D7mP3-YFiQd-1}{\nwixd{NW2D7mP3-YFiQd-1}\nwixu{NW2W5UTV-16KpI3-1}\nwixu{NW2W5UTV-2OWvsM-1}\nwixu{NW2W5UTV-4ZdLuY-1}\nwixu{NW2W5UTV-wXujK-1}}}%
\nwixlogsorted{c}{{Reduce: Random}{NW2D7mP3-4CvaEx-1}{\nwixd{NW2D7mP3-4CvaEx-1}}}%
\nwixlogsorted{c}{{Route: Shortest Path}{NW3gyy2C-1CU8MM-1}{\nwixd{NW3gyy2C-1CU8MM-1}\nwixu{NW2W5UTV-16KpI3-1}\nwixu{NW2W5UTV-2OWvsM-1}\nwixu{NW2W5UTV-4ZdLuY-1}\nwixu{NW2W5UTV-wXujK-1}}}%
\nwixlogsorted{c}{{Schedule Selection: Check Capacity}{NW9CtVI-2UeEeu-1}{\nwixd{NW9CtVI-2UeEeu-1}\nwixu{NW2W5UTV-16KpI3-1}\nwixu{NW2W5UTV-2OWvsM-1}\nwixu{NW2W5UTV-4ZdLuY-1}\nwixu{NW2W5UTV-wXujK-1}}}%
\nwixlogsorted{c}{{Schedule Selection: Check Time Window}{NW9CtVI-fUjQA-1}{\nwixd{NW9CtVI-fUjQA-1}\nwixu{NW2W5UTV-16KpI3-1}\nwixu{NW2W5UTV-2OWvsM-1}\nwixu{NW2W5UTV-4ZdLuY-1}\nwixu{NW2W5UTV-wXujK-1}}}%
\nwixlogsorted{c}{{Schedule: Insert}{NW22SnOZ-4V87KO-1}{\nwixd{NW22SnOZ-4V87KO-1}\nwixu{NW2W5UTV-16KpI3-1}\nwixu{NW2W5UTV-2OWvsM-1}\nwixu{NW2W5UTV-4ZdLuY-1}\nwixu{NW2W5UTV-wXujK-1}}}%
\nwixlogsorted{c}{{Shortest: Step 1: Initialize}{NW3gyy2C-3lMPNM-1}{\nwixu{NW3gyy2C-1CU8MM-1}\nwixd{NW3gyy2C-3lMPNM-1}}}%
\nwixlogsorted{c}{{Shortest: Step 2: Compute}{NW3gyy2C-2EZ2CY-1}{\nwixu{NW3gyy2C-1CU8MM-1}\nwixd{NW3gyy2C-2EZ2CY-1}}}%
\nwixlogsorted{c}{{Shortest: Step 3: Join}{NW3gyy2C-1OT4xQ-1}{\nwixu{NW3gyy2C-1CU8MM-1}\nwixd{NW3gyy2C-1OT4xQ-1}}}%
\nwixlogsorted{c}{{Shortest: Step 4: Fill}{NW3gyy2C-1nl6rv-1}{\nwixu{NW3gyy2C-1CU8MM-1}\nwixd{NW3gyy2C-1nl6rv-1}}}%
\nwixlogsorted{c}{{Utilities: get route cache}{NW2LUTbN-1fC59W-1}{\nwixu{NWEBrBs-4C3qWe-1}\nwixd{NW2LUTbN-1fC59W-1}}}%
\nwixlogsorted{c}{{Utilities: put route cache}{NW2LUTbN-wIy2f-1}{\nwixd{NW2LUTbN-wIy2f-1}}}%
\nwixlogsorted{c}{{Utilities: route cache}{NW2LUTbN-1rvh0k-1}{\nwixu{NW2W5UTV-qLZ3e-1}\nwixd{NW2LUTbN-1rvh0k-1}}}%
\nwbegindocs{58}\nwdocspar

\nwenddocs{}
